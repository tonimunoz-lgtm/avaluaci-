// app.js - lÃ²gica principal (modules)
import { openModal, closeModal, confirmAction } from './modals.js';
import * as Terms from './terms.js';
window.Terms = Terms;

/* ---------------- FIREBASE CONFIG ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyA0P7TWcEw9y9_13yqRhvsgWN5d3YKH7yo",
  authDomain: "gestornotes-cc6d0.firebaseapp.com",
  projectId: "gestornotes-cc6d0",
  storageBucket: "gestornotes-cc6d0.firebasestorage.app",
  messagingSenderId: "324570393360",
  appId: "1:324570393360:web:13a65fcf948813805c5395"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();


/* ---------------- Globals ---------------- */
let professorUID = null;
let currentClassId = null;
let classStudents = [];
let classActivities = [];
let deleteMode = false;
let currentCalcActivityId = null; // Activitat actual per fer cÃ lculs
let isDeleteMode = false;



/* Elements */
const loginScreen = document.getElementById('loginScreen');
const appRoot = document.getElementById('appRoot');
const usuariNom = document.getElementById('usuariNom');

const btnLogin = document.getElementById('btnLogin');
const btnRegister = document.getElementById('btnRegister');
const btnRecover = document.getElementById('btnRecover');
const btnLogout = document.getElementById('btnLogout');
const btnCreateClass = document.getElementById('btnCreateClass');

const screenClasses = document.getElementById('screen-classes');
const screenClass = document.getElementById('screen-class');
const classesGrid = document.getElementById('classesGrid');

const btnBack = document.getElementById('btnBack');
const btnAddStudent = document.getElementById('btnAddStudent');
const btnAddActivity = document.getElementById('btnAddActivity');
const btnSortAlpha = document.getElementById('btnSortAlpha');
const btnExport = document.getElementById('btnExport');

const studentsList = document.getElementById('studentsList');
const studentsCount = document.getElementById('studentsCount');

const notesThead = document.getElementById('notesThead');
const notesTbody = document.getElementById('notesTbody');
const notesTfoot = document.getElementById('notesTfoot');
const formulaTfoot = document.getElementById('formulaTfoot');

const modalCreateClassBtn = document.getElementById('modalCreateClassBtn');
const modalAddStudentBtn = document.getElementById('modalAddStudentBtn');
const modalAddActivityBtn = document.getElementById('modalAddActivityBtn');

const btnImportAL = document.getElementById('btnImportAL');
btnImportAL.addEventListener('click', () => {
  openModal('modalImportAL');
});

// Mobile: toggle students overlay
const btnToggleStudentsMobile = document.getElementById('btnToggleStudentsMobile');
const btnCloseStudentsMobile = document.getElementById('btnCloseStudentsMobile');

if (btnToggleStudentsMobile) {
  btnToggleStudentsMobile.addEventListener('click', () => {
    const cont = document.getElementById('studentsListContainer');
    if (!cont) return;
    cont.classList.add('mobile-open');
  });
}

if (btnCloseStudentsMobile) {
  btnCloseStudentsMobile.addEventListener('click', () => {
    const cont = document.getElementById('studentsListContainer');
    if (!cont) return;
    cont.classList.remove('mobile-open');
  });
}

// TambÃ© tancar si cliques a fora del card (overlay)
// detectem clicks al container perÃ² fora de .students-card
document.getElementById('studentsListContainer')?.addEventListener('click', (e) => {
  if (e.target.id === 'studentsListContainer') {
    document.getElementById('studentsListContainer').classList.remove('mobile-open');
  }
});

// MOBILE â€” OBRIR LLISTA ALUMNES
const btnMobile = document.getElementById("btnToggleStudentsMobile");
const cont = document.getElementById("studentsListContainer");

if (btnMobile) {
  btnMobile.addEventListener("click", () => {
    cont.classList.add("mobile-open");
  });
}

// TANCAR FENT CLIC FORA DEL PANELL BLANC
cont?.addEventListener("click", (e) => {
  if (e.target === cont) {
    cont.classList.remove("mobile-open");
  }
});

/* ---------- UTILS ---------- */
function showLogin() {
  loginScreen.style.display = 'block';
  loginScreen.classList.remove('hidden');
  appRoot.classList.add('hidden');
}
function showApp() {
  loginScreen.style.display = 'none';
  loginScreen.classList.add('hidden');
  appRoot.classList.remove('hidden');
}

/* ---------- AUTH ---------- */
//btnLogin.addEventListener('click', async () => {
//  const email = document.getElementById('loginEmail').value.trim();
//  const pw = document.getElementById('loginPassword').value;
//  if (!email || !pw) return alert('Introdueix email i contrasenya');

//  try {
//    const u = await auth.signInWithEmailAndPassword(email, pw);

//    const userDoc = await db.collection('professors').doc(u.user.uid).get();
//    if (userDoc.exists && userDoc.data().suspended) {
//      await auth.signOut();
//      alert("âš ï¸ El teu compte estÃ  suspÃ¨s.\nContacta amb lâ€™administrador.");
//      return;
//    }

//    professorUID = u.user.uid;
//    setupAfterAuth(u.user);

//  } catch (e) {
//    alert('Error login: ' + e.message);
//  }
//});

btnLogin.addEventListener('click', async () => {
  const email = document.getElementById('loginEmail').value.trim();
  const pw = document.getElementById('loginPassword').value;
  if (!email || !pw) return alert('Introdueix email i contrasenya');

  try {
    const u = await auth.signInWithEmailAndPassword(email, pw);

    const userDoc = await db.collection('professors').doc(u.user.uid).get();

    if (!userDoc.exists) {
      await auth.signOut();
      return alert("âš ï¸ Usuari no trobat. Contacta amb lâ€™administrador.");
    }

    // ðŸ”¹ ComprovaciÃ³ eliminat
    if (userDoc.data().deleted) {
      await auth.signOut();
      return alert("âš ï¸ El teu compte ha estat eliminat. Pots registrar-te de nou amb aquest email.");
    }

    // ðŸ”¹ ComprovaciÃ³ suspÃ¨s
    if (userDoc.data().suspended) {
      await auth.signOut();
      return alert("âš ï¸ El teu compte estÃ  suspÃ¨s.\nContacta amb lâ€™administrador.");
    }

    professorUID = u.user.uid;
    setupAfterAuth(u.user);

  } catch (e) {
    alert('Error login: ' + e.message);
  }
});

//-------loggin amb google----------------------
async function signInWithGoogleGmail() {
  const provider = new firebase.auth.GoogleAuthProvider();

  // Aquest scope permet enviar mails
  provider.addScope('https://www.googleapis.com/auth/gmail.send');

  try {
    const result = await firebase.auth().signInWithPopup(provider);

    // Guardem el token per enviar correus
    const credential = result.credential;
    window._googleAccessToken = credential.accessToken;

    alert("SessiÃ³ iniciada correctament. Ara pots enviar mails des del teu compte!");
  } catch (error) {
    console.error(error);
    alert("Error iniciant sessiÃ³ amb Google: " + error.message);
  }
}


/*document.getElementById("googleLoginBtn").addEventListener("click", async () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  
  // IMPORTANT â†’ Afegim permÃ­s dâ€™enviar mails
  provider.addScope("https://www.googleapis.com/auth/gmail.send");

  try {
    const result = await firebase.auth().signInWithPopup(provider);

    window._googleAccessToken = result.credential.accessToken;

    alert("SessiÃ³ iniciada correctament!");
  } catch (err) {
    console.error(err);
    alert("Error iniciant sessiÃ³ amb Google");
  }
});*/

// BotÃ³ login amb Google
const googleBtn = document.getElementById("googleLoginBtn");

if (googleBtn) {
  // Estil similar als altres botons perÃ² mÃ©s clar
  googleBtn.classList.add("bg-indigo-300"); // gradient mÃ©s suau o pots fer un gradient manual
  googleBtn.style.padding = "0.5rem 1rem";
  googleBtn.style.fontWeight = "600";
  googleBtn.style.borderRadius = "0.5rem";
  googleBtn.style.cursor = "pointer";
  googleBtn.style.width = "100%";        // mateixa amplada que els altres botons
  googleBtn.style.marginBottom = "0.5rem";  // separaciÃ³ amb el botÃ³ superior
  googleBtn.style.color = "white";       // text blanc
  
  // Afegim event listener
  googleBtn.addEventListener("click", async () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    // IMPORTANT â†’ Afegim permÃ­s dâ€™enviar mails
    provider.addScope("https://www.googleapis.com/auth/gmail.send");

    try {
      const result = await firebase.auth().signInWithPopup(provider);

      // Guardem el token per enviar correus
      window._googleAccessToken = result.credential.accessToken;

      alert("SessiÃ³ iniciada correctament! Ara pots enviar mails des del teu compte.");
    } catch (err) {
      console.error(err);
      alert("Error iniciant sessiÃ³ amb Google: " + err.message);
    }
  });
}



//btnRegister.addEventListener('click', async () => {
//  const email = document.getElementById('loginEmail').value.trim();
//  const pw = document.getElementById('loginPassword').value;
//  if (!email || !pw) return alert('Introdueix email i contrasenya');

//  try {
//    const u = await auth.createUserWithEmailAndPassword(email, pw);
//    professorUID = u.user.uid;

//    await db.collection('professors').doc(professorUID).set({
//      email,
//      nom: email.split('@')[0],
//      isAdmin: false,
//      suspended: false,
//      createdAt: firebase.firestore.Timestamp.now(),
//      classes: []
//    });

//    setupAfterAuth(u.user);

//  } catch(e) {
//    alert('Error registre: ' + e.message);
//  }
//});
btnRegister.addEventListener('click', async () => {
  const email = document.getElementById('loginEmail').value.trim();
  const pw = document.getElementById('loginPassword').value;
  if (!email || !pw) return alert('Introdueix email i contrasenya');

  try {
    // ðŸ”¹ Comprovar si ja hi ha un usuari amb aquest email
    const existingUsers = await db.collection('professors')
      .where('email', '==', email).get();

    if (!existingUsers.empty) {
      const userDoc = existingUsers.docs[0];
      if (userDoc.data().deleted) {
        // Reactivar usuari eliminat
        await db.collection('professors').doc(userDoc.id).update({
          deleted: false,
          suspended: false
        });

        const u = await auth.signInWithEmailAndPassword(email, pw);
        professorUID = u.user.uid;
        setupAfterAuth(u.user);
        return alert("Compte reactivat correctament!");
      } else {
        return alert("Error registre: Lâ€™email ja estÃ  en Ãºs.");
      }
    }

    // ðŸ”¹ Crear usuari nou
    const u = await auth.createUserWithEmailAndPassword(email, pw);
    professorUID = u.user.uid;
    await db.collection('professors').doc(professorUID).set({
      email,
      nom: email.split('@')[0],
      isAdmin: false,
      suspended: false,
      deleted: false,
      createdAt: firebase.firestore.Timestamp.now(),
      classes: []
    });

    setupAfterAuth(u.user);
    alert("Compte creat correctament!");

  } catch (e) {
    alert('Error registre: ' + e.message);
  }
});


btnRecover.addEventListener('click', () => {
  const email = document.getElementById('loginEmail').value.trim();
  if(!email) return alert('Introdueix el teu email per recuperar la contrasenya');
  auth.sendPasswordResetEmail(email)
    .then(()=> alert('Email de recuperaciÃ³ enviat!'))
    .catch(e=> alert('Error: ' + e.message));
});

btnLogout.addEventListener('click', ()=> {
  auth.signOut().then(()=> {
    professorUID = null;
    currentClassId = null;
    showLogin();
  });
});

auth.onAuthStateChanged(user => {
  if (user) {
    professorUID = user.uid;

    // ---------- REGISTRAR LOGIN ----------
    db.collection('professors').doc(user.uid).collection('logins')
      .add({ timestamp: firebase.firestore.Timestamp.now() })
      .catch(e => console.error('Error registrant login:', e));

    setupAfterAuth(user);
  } else {
    professorUID = null;
    showLogin();
  }
});


   
async function setupAfterAuth(user) {
  showApp();
  const email = user.email || '';
  usuariNom.textContent = email.split('@')[0] || email;

  // ----------------- AFEGIR OPCIÃ“ ADMIN -----------------
  const userDoc = await db.collection('professors').doc(user.uid).get();
  if (userDoc.exists && userDoc.data().isAdmin) {
    // Comprovem que encara no hi ha el botÃ³
    if (!document.getElementById('btnAdminPanel')) {
      const adminBtn = document.createElement('button');
      adminBtn.id = 'btnAdminPanel';
      adminBtn.className = 'w-full text-left px-2 py-1 hover:bg-gray-100';
      adminBtn.textContent = 'Administrar';
      adminBtn.addEventListener('click', () => {
        window.location.href = 'administrador.html';
      });
      document.getElementById('userMenu').appendChild(adminBtn);
    }
  }

  // Crida automÃ tica per carregar la graella de classes
  loadClassesScreen();
}



/* ---------------- Classes screen ---------------- */
btnCreateClass.addEventListener('click', ()=> openModal('modalCreateClass'));

/* ---------------- Classes Screen (cont.) ---------------- */
function loadClassesScreen() {
  if(!professorUID) { alert('Fes login primer.'); return; }
  screenClass.classList.add('hidden');
  screenClasses.classList.remove('hidden');
  classesGrid.innerHTML = '<div class="col-span-full text-sm text-gray-500">Carregant...</div>';

  const classColors = [
    'from-indigo-600 to-purple-600',
    'from-pink-500 to-red-500',
    'from-yellow-400 to-orange-500',
    'from-green-500 to-teal-500',
    'from-blue-500 to-indigo-600',
    'from-purple-500 to-pink-500'
  ];

  db.collection('professors').doc(professorUID).get().then(doc => {
    if(!doc.exists) { 
      classesGrid.innerHTML = '<div class="text-sm text-red-500">Professor no trobat</div>'; 
      return; 
    }
    const ids = doc.data().classes || [];
    if(ids.length === 0){
      classesGrid.innerHTML = `<div class="col-span-full p-6 bg-white dark:bg-gray-800 rounded shadow text-center text-lg">ðŸ”° No tens cap classe activa. <strong class="font-bold">Crea la primera!</strong></div>`;         
      return;
    }

    Promise.all(ids.map(id => db.collection('classes').doc(id).get()))
      .then(docs => {
        classesGrid.innerHTML = '';
        docs.forEach((d, i) => {
          if(!d.exists) return;
          const color = classColors[i % classColors.length];
          const card = document.createElement('div');
          card.className = `class-card bg-gradient-to-br ${color} text-white relative p-4 rounded-lg`;
          card.dataset.id = d.id;

          // Comptar activitats totals sumant totes les activitats de tots els termes
          let totalActivities = 0;
          const terms = d.data().terms || {};
          Object.values(terms).forEach(term => {
            totalActivities += (term.activities || []).length;
          });

          card.innerHTML = `
            ${deleteMode ? '<input type="checkbox" class="delete-checkbox absolute top-2 right-2 w-5 h-5">' : ''}
            <h3 class="text-lg font-bold">${d.data().nom||'Sense nom'}</h3>
            <p class="text-sm mt-2">${(d.data().alumnes||[]).length} alumnes Â· ${totalActivities} activitats</p>
            <div class="click-hint">${deleteMode ? 'Selecciona per eliminar' : 'Fes clic per obrir'}</div>
          `;

          if(!deleteMode){
            const menuDiv = document.createElement('div');
            menuDiv.className = 'absolute top-2 right-2';
            menuDiv.innerHTML = `
              <button class="menu-btn text-white font-bold text-xl">â‹®</button>
              <div class="menu hidden absolute right-0 mt-1 bg-white text-black border rounded shadow z-10 transition-opacity duration-200 opacity-0">
                <button class="edit-btn px-3 py-1 w-full text-left hover:bg-gray-100">Editar</button>
              </div>
            `;
            card.appendChild(menuDiv);

            const menuBtn = menuDiv.querySelector('.menu-btn');
            const menu = menuDiv.querySelector('.menu');

            menuBtn.addEventListener('click', e => {
              e.stopPropagation();
              document.querySelectorAll('.menu').forEach(m => m.classList.add('hidden'));
              menu.classList.toggle('hidden');
            });

            menuDiv.querySelector('.edit-btn').addEventListener('click', () => {
              const newName = prompt('Introdueix el nou nom de la classe:', d.data().nom || '');
              if(!newName || newName.trim() === d.data().nom) return;
              db.collection('classes').doc(d.id).update({ nom: newName.trim() })
                .then(() => loadClassesScreen())
                .catch(e => alert('Error editant classe: ' + e.message));
            });

            card.addEventListener('click', () => openClass(d.id));
          }

          classesGrid.appendChild(card);
        });

        const existingBtn = document.querySelector('#classesGrid + .delete-selected-btn');
        if(existingBtn) existingBtn.remove();
        if(deleteMode) addDeleteSelectedButton();
      });
  }).catch(e=> {
    classesGrid.innerHTML = `<div class="text-sm text-red-500">Error carregant classes</div>`;
    console.error(e);
  });
}

/* ---------------- Delete Mode Classes ---------------- */
const btnDeleteMode = document.getElementById('btnDeleteMode');
btnDeleteMode.addEventListener('click', ()=> {
  deleteMode = !deleteMode;
  btnDeleteMode.textContent = deleteMode ? 'âŒ CancelÂ·lar eliminar' : 'ðŸ—‘ï¸ Eliminar classe';
  loadClassesScreen();
});

function addDeleteSelectedButton(){
  const delBtn = document.createElement('button');
  delBtn.textContent = 'Eliminar seleccionats';
  delBtn.className = 'delete-selected-btn mt-3 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded shadow';
  delBtn.onclick = confirmDeleteSelected;
  classesGrid.parentNode.insertBefore(delBtn, classesGrid.nextSibling);
}

function confirmDeleteSelected(){
  const selected = [...document.querySelectorAll('.delete-checkbox')]
    .filter(chk => chk.checked)
    .map(chk => chk.closest('.class-card'));

  if(selected.length === 0) return alert('Selecciona almenys una classe!');

  confirmAction(
    'ConfirmaciÃ³ d\'eliminaciÃ³',
    `EstÃ s segur que vols eliminar ${selected.length} classe(s)? Aquesta acciÃ³ no tÃ© marxa enrere.`,
    () => {
      selected.forEach(card => {
        const classIdToRemove = card.dataset.id;
        card.remove();
        if(classIdToRemove){
          db.collection('professors').doc(professorUID).update({
            classes: firebase.firestore.FieldValue.arrayRemove(classIdToRemove)
          });
          db.collection('classes').doc(classIdToRemove).delete();
        }
      });
      deleteMode = false;
      btnDeleteMode.textContent = 'ðŸ—‘ï¸ Eliminar classe';
      loadClassesScreen();
    }
  );
}

/* ---------------- Create Class ---------------- */
function createClassModal(){
  const name = document.getElementById('modalClassName').value.trim();
  if(!name) return alert('Posa un nom');
  const ref = db.collection('classes').doc();
  ref.set({ nom: name, alumnes: [], activitats: [] })
    .then(()=> db.collection('professors').doc(professorUID).update({ classes: firebase.firestore.FieldValue.arrayUnion(ref.id) }))
    .then(()=> {
      closeModal('modalCreateClass');
      document.getElementById('modalClassName').value = '';
      loadClassesScreen();
    }).catch(e=> alert('Error: ' + e.message));
}
modalCreateClassBtn.addEventListener('click', createClassModal);

/* ---------------- Open Class ---------------- */
function openClass(id){
  currentClassId = id;
  screenClasses.classList.add('hidden');
  screenClass.classList.remove('hidden');
  loadClassData();
}

btnBack.addEventListener('click', ()=> {
  currentClassId = null;
  screenClass.classList.add('hidden');
  screenClasses.classList.remove('hidden');
  loadClassesScreen();
});

/* ---------------- Load Class Data ---------------- */
function loadClassData(){
  if(!currentClassId) return;
  db.collection('classes').doc(currentClassId).get().then(doc=>{
    if(!doc.exists) { alert('Classe no trobada'); return; }
    const data = doc.data();

    // Guardem dades locals com abans
    classStudents = data.alumnes || [];
    // NO assignem classActivities directament des d'aquÃ­; els activitats s'obtindran del terme actiu.
    // classActivities = data.activitats || [];
    document.getElementById('classTitle').textContent = data.nom || 'Sense nom';
    document.getElementById('classSub').textContent = `ID: ${doc.id}`;

    // Inicialitzar Terms passant db, id i dades de la classe
    Terms.setup(db, currentClassId, data, {
      onChange: (activeTermId) => {
        // Quan el terme actiu canvia, actualitzem classActivities i re-renderitzem la taula
        const acts = Terms.getActiveTermActivities();
        classActivities = Array.isArray(acts) ? acts : [];
        // TambÃ© actualitzem calculatedActivities si vols (si ho guardes dins del terme)
        // calculatedActivities = (data.terms && data.terms[activeTermId] && data.terms[activeTermId].calculatedActivities) || {};
        renderNotesGrid(); // renderitza la taula amb activitats del terme actiu
        // Actualitzar tÃ­tol per incloure nom terme al costat de nom classe
        const titleEl = document.getElementById('classTitle');
        if(titleEl) titleEl.textContent = `${data.nom} - ${Terms.getActiveTermName() || ''}`;
      }
    });

    // Render llista d'alumnes i altres UI
    renderStudentsList();
    // renderNotesGrid() serÃ  cridat per l'onChange del setup
  }).catch(e=> console.error(e));
}


/* ---------------- Students ---------------- */
btnAddStudent.addEventListener('click', ()=> openModal('modalAddStudent'));
modalAddStudentBtn.addEventListener('click', createStudentModal);

function createStudentModal(){
  const name = document.getElementById('modalStudentName').value.trim();
  if(!name) return alert('Posa un nom');
  const ref = db.collection('alumnes').doc();
  ref.set({ nom: name, notes: {} })
    .then(()=> db.collection('classes').doc(currentClassId).update({ alumnes: firebase.firestore.FieldValue.arrayUnion(ref.id) }))
    .then(()=> {
      closeModal('modalAddStudent');
      document.getElementById('modalStudentName').value = '';
      loadClassData();
    }).catch(e=> alert('Error: '+e.message));
}

function removeStudent(studentId) {
  confirmAction(
    'Eliminar alumne',
    'EstÃ s segur que vols eliminar aquest alumne?',
    () => {
      db.collection('classes').doc(currentClassId)
        .update({ alumnes: firebase.firestore.FieldValue.arrayRemove(studentId) })
        .then(() => db.collection('alumnes').doc(studentId).delete())
        .then(() => loadClassData())
        .catch(e => alert('Error eliminant alumne: ' + e.message));
    }
  );
}

function reorderStudents(fromIdx, toIdx){
  if(fromIdx===toIdx) return;
  const arr = Array.from(classStudents);
  const item = arr.splice(fromIdx,1)[0];
  arr.splice(toIdx,0,item);
  db.collection('classes').doc(currentClassId).update({ alumnes: arr })
    .then(()=> loadClassData())
    .catch(e=> console.error('Error reordenant', e));
}

btnSortAlpha.addEventListener('click', sortStudentsAlpha);
function sortStudentsAlpha(){
  Promise.all(classStudents.map(id => db.collection('alumnes').doc(id).get()))
    .then(docs=>{
      const pairs = docs.map(d=> ({ id: d.id, name: d.exists? (d.data().nom||'') : '' }));
      pairs.sort((a,b)=> a.name.localeCompare(b.name, 'ca'));
      const newOrder = pairs.map(p=> p.id);
      return db.collection('classes').doc(currentClassId).update({ alumnes: newOrder });
    }).then(()=> loadClassData())
    .catch(e=> console.error(e));
}
/* ---------------- Activities ---------------- */
btnAddActivity.addEventListener('click', ()=> openModal('modalAddActivity'));
modalAddActivityBtn.addEventListener('click', createActivityModal);

async function createActivityModal() {
    const name = document.getElementById("modalActivityName").value.trim();
    if (!name) return;

    const ref = db.collection("activitats").doc();

    await ref.set({
        nom: name,
        data: new Date().toISOString().split("T")[0],
        calcType: "numeric",
        formula: ""
    });

    // ðŸ”¥ AquÃ­ afegim l'activitat al terme actiu
    if (window.Terms && Terms.addActivityToActiveTerm) {
        await Terms.addActivityToActiveTerm(ref.id);
    } else {
        console.error("âŒ Terms no estÃ  carregat. Revisa l'import a app.js");
    }

    closeModal("modalAddActivity");
    document.getElementById("modalActivityName").value = "";

    // ðŸ”¥ NO posar loadClassData() si tens dubtes!
    // Si vols recarregar:
    if (typeof loadClassData === "function") {
        loadClassData();
    }
}


function removeActivity(actId){
  confirmAction('Eliminar activitat', 'Esborrar activitat i totes les notes relacionades?', async ()=> {
    try {
      const termId = Terms.getActiveTermId(); // obtenir terme actiu

      // Eliminar activitat del llistat general i del terme actiu
      await db.collection('classes').doc(currentClassId).update({
        activitats: firebase.firestore.FieldValue.arrayRemove(actId),
        [`terms.${termId}.activities`]: firebase.firestore.FieldValue.arrayRemove(actId)
      });

      // Eliminar notes dels alumnes
      const batch = db.batch();
      classStudents.forEach(sid => {
        const ref = db.collection('alumnes').doc(sid);
        batch.update(ref, { [`notes.${actId}`]: firebase.firestore.FieldValue.delete() });
      });
      await batch.commit();

      // Refrescar dades
      loadClassData();

    } catch(e) {
      alert('Error esborrant activitat: ' + e.message);
    }
  });
}


/* ---------------- Render Students List amb menÃº ---------------- */
function renderStudentsList() {
  studentsList.innerHTML = '';
  studentsCount.textContent = `(${classStudents.length})`;

  // ðŸ”Ž Connectem la barra de cerca
  const searchInput = document.getElementById('studentSearch');
  if (searchInput && !searchInput.dataset.bound) {
    searchInput.addEventListener('input', filterStudentsList);
    searchInput.dataset.bound = "true"; // Evita duplicar el listener
  }

  if (classStudents.length === 0) {
    studentsList.innerHTML = '<li class="text-sm text-gray-400">No hi ha alumnes</li>';
    return;
  }

  classStudents.forEach((stuId, idx) => {
    db.collection('alumnes').doc(stuId).get().then(doc => {
      const data = doc.data() || {};
      const name = data.nom || 'Desconegut';
      const email = data.email || '';

      const li = document.createElement('li');
      li.className = 'flex items-center justify-between bg-gray-50 dark:bg-gray-900 p-2 rounded';
      li.dataset.studentId = stuId;
      if (email) li.dataset.email = email;

      li.innerHTML = `
        <div class="flex items-center gap-3">
          <span draggable="true" title="Arrossega per reordenar" class="cursor-move text-sm text-gray-500">â˜°</span>
          <span class="stu-name font-medium">${name}</span>
        </div>
        <div class="relative">
          <button class="menu-btn text-gray-500 hover:text-gray-700 dark:hover:text-white tooltip">â‹®</button>
          <div class="menu hidden absolute right-0 mt-1 bg-white dark:bg-gray-800 border rounded shadow z-10">
            <button class="edit-btn px-3 py-1 w-full text-left hover:bg-gray-100 dark:hover:bg-gray-700">Editar</button>
            <button class="set-email-btn px-3 py-1 w-full text-left hover:bg-gray-100 dark:hover:bg-gray-700 whitespace-nowrap">Introduir email</button>          
            <button class="delete-btn px-3 py-1 w-full text-left hover:bg-gray-100 dark:hover:bg-gray-700">Eliminar</button>
          </div>
        </div>
      `;

      const menuBtn = li.querySelector('.menu-btn');
      const menu = li.querySelector('.menu');

      menuBtn.addEventListener('click', e => {
        e.stopPropagation();
        document.querySelectorAll('.menu').forEach(m => m.classList.add('hidden'));
        menu.classList.toggle('hidden');
      });

      // EDITAR
      li.querySelector('.edit-btn').addEventListener('click', () => {
        const newName = prompt('Introdueix el nou nom:', name);
        if (!newName || newName.trim() === name) return;
        db.collection('alumnes').doc(stuId).update({ nom: newName.trim() })
          .then(() => loadClassData())
          .catch(e => alert('Error editant alumne: ' + e.message));
      });

      // INTRODUIR EMAIL
      li.querySelector('.set-email-btn').addEventListener('click', async () => {
        const current = li.dataset.email || '';
        const newMail = prompt("Introdueix email:", current);
        if (!newMail) return;

        await db.collection('alumnes').doc(stuId).update({ email: newMail.trim() });
        li.dataset.email = newMail.trim();
        alert("Email guardat.");
      });

      // ELIMINAR
      li.querySelector('.delete-btn').addEventListener('click', () => removeStudent(stuId));

      // DRAG
      const dragHandle = li.querySelector('[draggable]');
      dragHandle.addEventListener('dragstart', e => {
        e.dataTransfer.setData('text/plain', idx);
      });
      li.addEventListener('dragover', e => e.preventDefault());
      li.addEventListener('drop', e => {
        e.preventDefault();
        const fromIdx = Number(e.dataTransfer.getData('text/plain'));
        reorderStudents(fromIdx, idx);
      });

      studentsList.appendChild(li);

      // SI EL MODE ENVIAR NOTES Ã‰S ACTIU â†’ AFEGIU CHECKBOXES
      if (window.__sendNotesModeActive) {
        showSendModeCheckboxes();
        showExitSendNotesButton();
      }
    });
  });
}


//------------------------------------------------nuevo-------------------------------------------------------
/* ================================
   MENÃš GLOBAL D'ALUMNES
================================= */

const studentsMenuBtn = document.getElementById('studentsMenuBtn');
const studentsMenu = document.getElementById('studentsMenu');
const deleteStudentsModeBtn = document.getElementById('deleteStudentsModeBtn');

studentsMenuBtn.addEventListener('click', e => {
    e.stopPropagation();
    studentsMenu.classList.toggle('hidden');
});

// Tancar menÃºs quan es clica fora
document.addEventListener('click', () => {
    studentsMenu.classList.add('hidden');
});

/* ðŸ”¥ Activar mode d'eliminaciÃ³ mÃºltiple */
deleteStudentsModeBtn.addEventListener('click', () => {
    activateDeleteStudentsMode();
});



/* ---------------- Notes Grid amb menÃº activitats ---------------- */
async function renderNotesGrid() {
  // Neteja taula
  notesThead.innerHTML = '';
  notesTbody.innerHTML = '';
  notesTfoot.innerHTML = '';
  formulaTfoot.innerHTML = '';

  // CapÃ§alera alumne
  const headRow = document.createElement('tr');
  headRow.appendChild(th('Alumne'));

  // Carrega classe
  const classDoc = await db.collection('classes').doc(currentClassId).get();
  if (!classDoc.exists) return;
  const classData = classDoc.data();
  const calculatedActs = classData.calculatedActivities || {};

  // Carrega activitats
  const actDocs = await Promise.all(classActivities.map(id => db.collection('activitats').doc(id).get()));

  // CapÃ§alera activitats amb icona refresh i candau
  actDocs.forEach(adoc => {
    const id = adoc.id;
    const name = adoc.exists ? (adoc.data().nom || 'Sense nom') : 'Desconegut';

    const thEl = th('');
    const container = document.createElement('div');
    container.className = 'flex items-center justify-between';

    const spanName = document.createElement('span');
    spanName.textContent = name;

   // Candau
const lockIcon = document.createElement('span');
lockIcon.className = 'lock-icon cursor-pointer mr-1';
lockIcon.innerHTML = calculatedActs[id]?.locked ? 'ðŸ”’' : 'ðŸ”“';
lockIcon.title = calculatedActs[id]?.locked ? 'Activitat bloquejada' : 'Activitat desbloquejada';

// Amaguem el candau si Ã©s una activitat calculada
if (calculatedActs[id]?.calculated) {
    lockIcon.classList.add('hidden');
}

lockIcon.addEventListener('click', async () => {
  try {
    const newLockState = !calculatedActs[id]?.locked;

    // Guardar a Firestore
    await db.collection('classes').doc(currentClassId).update({
      // assegurem que l'objecte existeixi i calculem la propietat
      [`calculatedActivities.${id}.locked`]: newLockState
    });

    // Si no existia l'entrada a local, la creem per evitar undefined errors
    if (!calculatedActs[id]) calculatedActs[id] = {};
    calculatedActs[id].locked = newLockState;

    // ðŸ”¥ Afegir aquesta lÃ­nia perquÃ¨ la UI es torni a generar amb lâ€™estat correcte
await renderNotesGrid();

    // Actualitzar icona
    lockIcon.innerHTML = newLockState ? 'ðŸ”’' : 'ðŸ”“';
    lockIcon.title = newLockState ? 'Activitat bloquejada' : 'Activitat desbloquejada';

    // Estat de bloqueig real (si Ã©s calculada, tambÃ© bloquejada)
    const locked = newLockState || Boolean(calculatedActs[id]?.calculated);

    // Actualitzar inputs IMMEDIATAMENT (sense esperar un render complet)
    document.querySelectorAll(`tr[data-student-id]`).forEach(tr => {
      const input = tr.querySelector(`input[data-activity-id="${id}"]`);
      if (!input) return;

      // Usem readOnly en lloc de disabled per no trencar reactivitat/estils
      input.readOnly = locked;

      // mantenim els colors de fons CRÃTIC: no sobreescrivim si ja tÃ© classes de color
      // si vols marcar visualment bloquejat, afegeix una classe mÃ­nima que no sobreescrigui colors
      if (locked) {
  input.disabled = true;
  input.classList.add('blocked-cell');
} else {
  input.disabled = false;
  input.classList.remove('blocked-cell');
}

      // Reapliquem la coloraciÃ³ basada en valor (applyCellColor) perquÃ¨ no es perdin estils
      applyCellColor(input);
    });

    // Opcional: si vols re-renderitzar tota la taula per altres canvis, crida renderNotesGrid()
    // renderNotesGrid();
  } catch (e) {
    console.error('Error canviant bloqueig:', e);
    alert('Error canviant bloqueig: ' + e.message);
  }
});



    // Icona refrescar (nomÃ©s si Ã©s calculada)
    const refreshIcon = document.createElement('span');
    refreshIcon.innerHTML = 'ðŸ”„';
    refreshIcon.title = 'Refrescar columna';
    refreshIcon.className = 'ml-2 cursor-pointer hidden';
    if (calculatedActs[id]?.calculated) refreshIcon.classList.remove('hidden');

    refreshIcon.addEventListener('click', async (e) => {
      e.stopPropagation();
      const formulasRow = formulaTfoot.querySelector('.formulas-row');
      if (!formulasRow) return;
      const idx = Array.from(headRow.children).indexOf(thEl);
      const formulaTd = formulasRow.children[idx];
      if (!formulaTd) return;
      const formulaText = formulaTd.textContent.trim();
      if (!formulaText) return alert('No hi ha cap fÃ³rmula aplicada a aquesta activitat.');

      try {
        // Aplicar fÃ³rmula a tots els alumnes i esperar que es guardi
        await Promise.all(classStudents.map(async sid => {
          const result = await evalFormulaAsync(formulaText, sid);
          await saveNote(sid, id, result);
        }));

        // Quan acabi, actualitzem la vista i reapliquem colors
        await renderNotesGrid();
      } catch(err) {
        console.error('Error recalculant fÃ³rmula:', err);
        alert('Error recalculant la fÃ³rmula: ' + err.message);
      }
    });

    const menuDiv = document.createElement('div');
    menuDiv.className = 'relative';
    menuDiv.innerHTML = `
      <button class="menu-btn text-gray-500 hover:text-gray-700 dark:hover:text-white tooltip">â‹®</button>
      <div class="menu hidden absolute right-0 mt-1 bg-white dark:bg-gray-800 border rounded shadow z-10">
        <button class="edit-btn px-3 py-1 w-full text-left hover:bg-gray-100 dark:hover:bg-gray-700">Editar</button>
        <button class="delete-btn px-3 py-1 w-full text-left hover:bg-gray-100 dark:hover:bg-gray-700">Eliminar</button>
        <button class="calc-btn px-3 py-1 w-full text-left hover:bg-gray-100 dark:hover:bg-gray-700">CÃ lcul</button>
        <button class="clear-btn px-3 py-1 w-full text-left hover:bg-gray-100 dark:hover:bg-gray-700">Netejar</button>
      </div>
    `;

    container.prepend(lockIcon);
    container.appendChild(spanName);
    container.appendChild(refreshIcon);
    container.appendChild(menuDiv);
    thEl.appendChild(container);
    headRow.appendChild(thEl);

    // Estil per capÃ§aleres calculades
    if (calculatedActs[id]?.calculated) {
      thEl.style.backgroundColor = "#dbeafe";
      thEl.style.borderBottom = "3px solid #1d4ed8";
      thEl.style.color = "black";
    }

    // MenÃº activitat
    const menuBtn = menuDiv.querySelector('.menu-btn');
    const menu = menuDiv.querySelector('.menu');
    menuBtn.addEventListener('click', e => {
      e.stopPropagation();
      document.querySelectorAll('.menu').forEach(m => m.classList.add('hidden'));
      menu.classList.toggle('hidden');
    });

    menuDiv.querySelector('.edit-btn').addEventListener('click', () => {
      const newName = prompt('Nou nom activitat:', name);
      if (!newName || newName.trim() === name) return;
      db.collection('activitats').doc(id).update({ nom: newName.trim() }).then(() => renderNotesGrid());
    });

    menuDiv.querySelector('.clear-btn').addEventListener('click', async () => {
      if (!confirm('Segur que vols esborrar totes les notes dâ€™aquesta activitat?')) return;
      try {
        await Promise.all(classStudents.map(sid => saveNote(sid, id, '')));
        await db.collection('classes').doc(currentClassId).update({
          [`calculatedActivities.${id}`]: firebase.firestore.FieldValue.delete()
        });
        renderNotesGrid();
      } catch(e) {
        console.error('Error netejant notes:', e);
        alert('Error netejant les notes: ' + e.message);
      }
    });

menuDiv.querySelector('.delete-btn').addEventListener('click', () => {
  confirmAction('Eliminar activitat', 'Esborrar activitat i totes les notes relacionades?', async () => {
    try {
      // Eliminar del terme actiu
      await Terms.removeActivityFromActiveTerm(id);

      // Eliminar de la llista general dâ€™activitats de la classe
      await db.collection('classes').doc(currentClassId)
              .update({ activitats: firebase.firestore.FieldValue.arrayRemove(id) });

      // Esborrar les notes dels alumnes
      const batch = db.batch();
      classStudents.forEach(sid => {
        const ref = db.collection('alumnes').doc(sid);
        batch.update(ref, { [`notes.${id}`]: firebase.firestore.FieldValue.delete() });
      });
      await batch.commit();

      // Refrescar graella i capÃ§aleres
      renderNotesGrid();
    } catch(e) {
      alert('Error esborrant activitat: ' + e.message);
    }
  });
});

    menuDiv.querySelector('.calc-btn').addEventListener('click', () => openCalcModal(id));

  });

  headRow.appendChild(th('Mitjana', 'text-right'));
  notesThead.appendChild(headRow);

  enableActivityDrag();

  if (classStudents.length === 0) {
    notesTbody.innerHTML = `<tr><td class="p-3 text-sm text-gray-400" colspan="${classActivities.length + 2}">No hi ha alumnes</td></tr>`;
    renderAverages();
    return;
  }

  // Carrega alumnes (una sola vegada)
  const studentDocs = await Promise.all(classStudents.map(id => db.collection('alumnes').doc(id).get()));

  studentDocs.forEach(sdoc => {
    const studentId = sdoc.id;
    const studentData = sdoc.exists ? sdoc.data() : { nom: 'Desconegut', notes: {} };

    const tr = document.createElement('tr');
    tr.dataset.studentId = studentId;

    const tdName = document.createElement('td');
    tdName.className = 'border px-2 py-1';
    tdName.textContent = studentData.nom;
    tr.appendChild(tdName);

    // Per cada activitat afegim la celÂ·la i l'input
    actDocs.forEach(actDoc => {
      const actId = actDoc.id;
      const val = (studentData.notes && studentData.notes[actId] !== undefined) ? studentData.notes[actId] : '';

      const td = document.createElement('td');
      td.className = 'border px-2 py-1';

      if (calculatedActs[actId]?.calculated) {
        td.style.backgroundColor = "#dbeafe"; // capÃ§alera blava i celÂ·la alguna cosa similar
      }

      const input = document.createElement('input');
      input.type = 'number';
      input.min = 0;
      input.max = 10;
      input.value = val;
      input.dataset.activityId = actId;
      input.className = 'table-input text-center rounded border p-1';

      // Estat bloquejat si Ã©s calculada o hi ha lock
      const isLocked = !!(calculatedActs[actId]?.locked) || !!(calculatedActs[actId]?.calculated);
      input.disabled = isLocked;
      // ðŸ”¥ IMPORTANT: Afegir la classe visual persistent
if (isLocked) {
    input.classList.add('blocked-cell');
} else {
    input.classList.remove('blocked-cell');
}

      // Reaplica color sempre (aixÃ² evita que quedi en gris)
      applyCellColor(input);

      // HANDLER: quan l'usuari canvia la nota, fem un save i actualitzem UI nomÃ©s quan saveNote acaba.
      if (!isLocked) {
        input.addEventListener('input', () => {
          // color en viu mentre escriu
          applyCellColor(input);
        });

        input.addEventListener('change', async (e) => {
          const newVal = e.target.value;
          try {
            // Opcional: desactivar l'input mentre guardem per evitar mÃºltiples clicks rÃ pids
            input.disabled = true;

            // Guardem la nota a Firestore (await)
            await saveNote(studentId, actId, newVal);

            // Quan ja estÃ  guardada: reapliquem color (i recalculs locals rÃ pids)
            applyCellColor(input);

            // Actualitza mitjanes i mitjanes per activitat (local)
            renderAverages();

            // Si vols forÃ§ar refresc de columnes calculades relatives, pots cridar updateCalculatedCells()
            // updateCalculatedCells(); // opcional

          } catch (err) {
            console.error('Error guardant nota:', err);
            alert('Error guardant la nota: ' + err.message);
          } finally {
            // Tornem a aplicar disabled si la columna estÃ  bloquejada ara
            const nowLocked = !!(calculatedActs[actId]?.locked) || !!(calculatedActs[actId]?.calculated);
            input.disabled = nowLocked;
          }
        });
      } else {
        // Si estÃ  bloquejat, perÃ² vols que el color reflecteixi el valor actual, ja estÃ  feta applyCellColor()
        // No afegim handlers
      }

// ðŸ”½ NavegaciÃ³ amb Enter, Shift+Enter i fletxes
input.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
        e.preventDefault();

        const currentAct = input.dataset.activityId;
        const currentStudent = tr.dataset.studentId;

        // Trobar la fila actual
        const rows = Array.from(notesTbody.querySelectorAll('tr[data-student-id]'));
        const rowIndex = rows.findIndex(r => r.dataset.studentId === currentStudent);

        const nextRowIndex = e.shiftKey ? rowIndex - 1 : rowIndex + 1;

        if (rows[nextRowIndex]) {
            const nextInput = rows[nextRowIndex].querySelector(`input[data-activity-id="${currentAct}"]`);
            if (nextInput && !nextInput.disabled) nextInput.focus();
        }
    }
      if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
    e.preventDefault(); // evita increment automÃ tic
}
    // ðŸ”¼ Fletxa amunt
    if (e.key === 'ArrowUp') {
        const rows = Array.from(notesTbody.querySelectorAll('tr[data-student-id]'));
        const rowIndex = rows.findIndex(r => r.dataset.studentId === tr.dataset.studentId);
        if (rows[rowIndex - 1]) {
            const nextInput = rows[rowIndex - 1].querySelector(`input[data-activity-id="${input.dataset.activityId}"]`);
            if (nextInput && !nextInput.disabled) nextInput.focus();
        }
    }

    // ðŸ”½ Fletxa avall
    if (e.key === 'ArrowDown') {
        const rows = Array.from(notesTbody.querySelectorAll('tr[data-student-id]'));
        const rowIndex = rows.findIndex(r => r.dataset.studentId === tr.dataset.studentId);
        if (rows[rowIndex + 1]) {
            const nextInput = rows[rowIndex + 1].querySelector(`input[data-activity-id="${input.dataset.activityId}"]`);
            if (nextInput && !nextInput.disabled) nextInput.focus();
        }
    }
});


      
      td.appendChild(input);
      tr.appendChild(td);
    });
    
    // Mitjana alumne
    const avgTd = document.createElement('td');
    avgTd.className = 'border px-2 py-1 text-right font-semibold';
    avgTd.textContent = computeStudentAverageText(studentData);
    tr.appendChild(avgTd);

    notesTbody.appendChild(tr);
  });

  // Final: recalculs de mitjanes i fila fÃ³rmules (igual que abans)
  renderAverages();
}




// FunciÃ³ per actualitzar celÂ·les calculades sense recrear tota la taula
function updateCalculatedCells() {
  db.collection('classes').doc(currentClassId).get().then(doc => {
    if (!doc.exists) return;
    const calculatedActs = doc.data().calculatedActivities || {};

    classStudents.forEach(sid => {
      const row = document.querySelector(`tr[data-student-id="${sid}"]`);
      if (!row) return;

      classActivities.forEach(aid => {
        if (!calculatedActs[aid]) return;
        const input = row.querySelector(`input[data-activity-id="${aid}"]`);
        if (!input) return;

        const val = computeCalculatedNote(sid, aid); // funciÃ³ que calcula nota
        input.value = val;
        input.disabled = true;
        input.style.backgroundColor = "#fca5a5";
      });
    });
  });
}

//--------------nou per incloure buscador am filtre
const gridStudentSearch = document.getElementById('gridStudentSearch');
gridStudentSearch.addEventListener('input', () => {
  const filter = gridStudentSearch.value.toLowerCase();
  notesTbody.querySelectorAll('tr').forEach(tr => {
    const studentName = tr.children[0].textContent.toLowerCase();
    tr.style.display = studentName.includes(filter) ? '' : 'none';
  });
});



/* ---------------- Helpers Notes & Excel ---------------- */
function th(txt, cls=''){
  const el = document.createElement('th');
  el.className = 'border px-2 py-1 ' + cls;
  el.textContent = txt;
  return el;
}

// Canvia saveNote perquÃ¨ NO re-renderitzi la taula
function saveNote(studentId, activityId, value){
  const num = value === '' ? null : Number(value);
  const updateObj = {};
  if(num === null || isNaN(num)) updateObj[`notes.${activityId}`] = firebase.firestore.FieldValue.delete();
  else updateObj[`notes.${activityId}`] = num;

  return db.collection('alumnes').doc(studentId).update(updateObj)
    .catch(e=> console.error('Error saving note', e));
}


function applyCellColor(inputEl){
  const v = Number(inputEl.value);
  inputEl.classList.remove('bg-purple-100','bg-red-100','bg-yellow-100','bg-green-100');
  if(inputEl.value === '' || isNaN(v)) return;
  if(v < 2.5) inputEl.classList.add('bg-red-100');
  else if(v < 5) inputEl.classList.add('bg-yellow-100');  
  else if(v < 7) inputEl.classList.add('bg-purple-100');
  else inputEl.classList.add('bg-green-100');
}

function computeStudentAverageText(studentData){
  const notesMap = (studentData && studentData.notes) ? studentData.notes : {};
  const vals = classActivities.map(aid => (notesMap[aid] !== undefined ? Number(notesMap[aid]) : null)).filter(v=> v!==null && !isNaN(v));
  if(vals.length === 0) return '';
  return (vals.reduce((s,n)=> s+n,0)/vals.length).toFixed(2);
}

function renderAverages(){
  // Actualitzar mitjanes alumnes
  Array.from(notesTbody.children).forEach(tr=>{
    const inputs = Array.from(tr.querySelectorAll('input')).map(i=> Number(i.value)).filter(v=> !isNaN(v));
    const lastTd = tr.querySelectorAll('td')[tr.querySelectorAll('td').length - 1];
    lastTd.textContent = inputs.length ? (inputs.reduce((a,b)=>a+b,0)/inputs.length).toFixed(2) : '';
  });

  const actCount = classActivities.length;
  notesTfoot.innerHTML = '';

  // ----------------- Mitjana per activitat -----------------
  const trAvg = document.createElement('tr');
  trAvg.className = 'text-sm';
  trAvg.appendChild(th('Mitjana activitat'));
  if(actCount === 0){
    trAvg.appendChild(th('',''));
    notesTfoot.appendChild(trAvg);
    return;
  }

  for(let i=0;i<actCount;i++){
    const inputs = Array.from(notesTbody.querySelectorAll('tr')).map(r => r.querySelectorAll('input')[i]).filter(Boolean);
    const vals = inputs.map(inp => Number(inp.value)).filter(v=> !isNaN(v));
    const avg = vals.length ? (vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(2) : '';
    const td = document.createElement('td');
    td.className = 'border px-2 py-1 text-center font-semibold';
    td.textContent = avg;
    trAvg.appendChild(td);
  }
  trAvg.appendChild(th('',''));
  notesTfoot.appendChild(trAvg);

  // ----------------- Fila fÃ³rmules -----------------
  const trForm = document.createElement('tr');
  trForm.className = 'formulas-row text-sm bg-gray-100';
  const td0 = document.createElement('td');
  td0.textContent = 'FÃ³rmula';
  td0.className = 'border px-2 py-1 font-medium text-center';
  trForm.appendChild(td0);

  // Llegim fÃ³rmules de Firestore
  db.collection('classes').doc(currentClassId).get().then(doc=>{
    if(!doc.exists) return;
    const calculatedActs = doc.data().calculatedActivities || {};

    for(let i=0;i<actCount;i++){
      const actId = classActivities[i];
      const td = document.createElement('td');
      td.className = 'border px-2 py-1 text-center font-medium';
      td.textContent = calculatedActs[actId]?.formula || '';
      trForm.appendChild(td);
    }

    const tdLast = document.createElement('td');
    tdLast.textContent = '';
    tdLast.className = 'border px-2 py-1 text-center font-medium';
    trForm.appendChild(tdLast);

    formulaTfoot.appendChild(trForm);
  });
}




/* ---------------- Open Calculation Modal ---------------- */
function openCalcModal(activityId){
  currentCalcActivityId = activityId; 
  openModal('modalCalc');
  // Reset modal
  document.getElementById('calcType').value = 'numeric';
  document.getElementById('formulaInputs').classList.add('hidden');
  document.getElementById('numericInput').classList.remove('hidden');
  document.getElementById('numericField').value = '';
  document.getElementById('formulaField').value = '';
}
/* ---------------- Modal Calcul: Numeric / Formula ---------------- */
const calcTypeSelect = document.getElementById('calcType');
const numericDiv = document.getElementById('numericInput');
const numericField = document.getElementById('numericField');
const formulaDiv = document.getElementById('formulaInputs');
const formulaField = document.getElementById('formulaField');
const formulaButtonsDiv = document.getElementById('formulaButtons');
const modalApplyCalcBtn = document.getElementById('modalApplyCalcBtn');

// Canvi tipus cÃ lcul
calcTypeSelect.addEventListener('change', ()=>{
  if(calcTypeSelect.value==='numeric'){
    numericDiv.classList.remove('hidden');
    formulaDiv.classList.add('hidden');
  } else if(calcTypeSelect.value==='formula'){
    numericDiv.classList.add('hidden');
    formulaDiv.classList.remove('hidden');
    buildFormulaButtons(); // activitats + operadors + nÃºmeros
  } else if(calcTypeSelect.value==='rounding'){
    numericDiv.classList.add('hidden');
    formulaDiv.classList.remove('hidden');
    buildRoundingButtons(); // ACTIVITATS + 0,5 i 1
  }
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Numeric
async function applyNumeric(val) {
  if (isNaN(val)) throw new Error('Introdueix un nÃºmero vÃ lid');
  await Promise.all(classStudents.map(sid => saveNote(sid, currentCalcActivityId, val)));
}

// Formula
async function applyFormula(formula) {
  if (!formula.trim()) throw new Error('Formula buida');
  await Promise.all(classStudents.map(async sid => {
    const result = await evalFormulaAsync(formula, sid);
    await saveNote(sid, currentCalcActivityId, result);
  }));
}

// Rounding
async function applyRounding(formula) {
  if (!formula.trim()) throw new Error('Selecciona activitat i 0,5 o 1');

  // Llegim totes les activitats
  const activityDocs = await Promise.all(classActivities.map(aid => db.collection('activitats').doc(aid).get()));
  const selectedActivityDoc = activityDocs.find(doc => doc.exists && formula.startsWith(doc.data().nom));
  if (!selectedActivityDoc) throw new Error('Activitat no trobada');

  const selectedActivityName = selectedActivityDoc.data().nom;
  const multiplier = Number(formula.slice(selectedActivityName.length)) || 1;

  await Promise.all(classStudents.map(async sid => {
    const studentDoc = await db.collection('alumnes').doc(sid).get();
    const notes = studentDoc.exists ? studentDoc.data().notes || {} : {};
    let val = Number(notes[selectedActivityDoc.id]) || 0;

    if (multiplier === 1) val = Math.round(val);
    else if (multiplier === 0.5) val = Math.round(val * 2) / 2;

    await saveNote(sid, currentCalcActivityId, val);
  }));
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Event Listener â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
modalApplyCalcBtn.addEventListener('click', async () => {
  if (!currentCalcActivityId) return;

  try {
    let formulaText = ''; // fÃ³rmula de codi (amb marcador per id)
    let displayFormulaText = ''; // fÃ³rmula per mostrar (amb nom activitat)

    switch (calcTypeSelect.value) {
      case 'numeric':
        await applyNumeric(Number(numericField.value));
        formulaText = numericField.value;
        displayFormulaText = numericField.value;
        break;

      case 'formula':
        await applyFormula(formulaField.value);
        // Guardem la mateixa cadena tant per codi com per visualitzaciÃ³
        formulaText = formulaField.value;
        displayFormulaText = formulaField.value;
        break;

      case 'rounding':
        if (!formulaField.value.trim()) throw new Error('Selecciona activitat i 0,5 o 1');

        // Trobar l'activitat seleccionada per nom (nom complet) entre les activitats de la classe
        const activityDocs = await Promise.all(classActivities.map(aid => db.collection('activitats').doc(aid).get()));
        // Busquem el document que coincideixi amb l'inici del string de formulaField (com feies abans)
        const selectedActivityDoc = activityDocs.find(doc => doc.exists && formulaField.value.startsWith(doc.data().nom));
        if (!selectedActivityDoc) throw new Error('Activitat no trobada');

        const selectedActivityName = selectedActivityDoc.data().nom;
        const selectedActivityId = selectedActivityDoc.id;

        // Extraiem multiplicador (si hi ha) â€” p.ex. "Tema1" + "0.5" o "1"
        const multiplierStr = formulaField.value.slice(selectedActivityName.length).trim();
        const multiplier = multiplierStr === '' ? 1 : Number(multiplierStr);

        // Aplicar arrodoniment a cada alumne (usar sempre l'ID per llegir la nota)
        await Promise.all(classStudents.map(async sid => {
          const studentDoc = await db.collection('alumnes').doc(sid).get();
          const notes = studentDoc.exists ? studentDoc.data().notes || {} : {};
          let val = Number(notes[selectedActivityId]);
          if (isNaN(val)) val = 0;

          if (multiplier === 1) val = Math.round(val);
          else if (multiplier === 0.5) val = Math.round(val * 2) / 2;

          await saveNote(sid, currentCalcActivityId, val);
        }));

        // Guardem la fÃ³rmula de codi amb un marcador Ãºnic per l'ID (evita ambigÃ¼itats)
        if (multiplier === 1) {
          formulaText = `Math.round(__ACT__${selectedActivityId})`;
          displayFormulaText = `Math.round(${selectedActivityName})`;
        } else if (multiplier === 0.5) {
          formulaText = `Math.round(__ACT__${selectedActivityId}*2)/2`;
          displayFormulaText = `Math.round(${selectedActivityName}*2)/2`;
        } else {
          // cas inesperat: guardem la fÃ³rmula simple amb marcador
          formulaText = `__ACT__${selectedActivityId}`;
          displayFormulaText = `${selectedActivityName}`;
        }

        break;

      default:
        throw new Error('Tipus de cÃ lcul desconegut');
    }

    // Guardar a Firestore la informaciÃ³ de fÃ³rmula a calculatedActivities
    if (currentClassId) {
      // Guardem tant formula (codi) com displayFormula (text per mostrar)
      await db.collection('classes').doc(currentClassId).update({
        [`calculatedActivities.${currentCalcActivityId}`]: {
          calculated: true,
          formula: formulaText,
          displayFormula: displayFormulaText
        }
      });
    }

    closeModal('modalCalc');
    renderNotesGrid(); // Re-render per actualitzar celÂ·les i fila fÃ³rmules
  } catch (e) {
    console.error(e);
    alert('Error en aplicar el cÃ lcul: ' + e.message);
  }
});


// ---------------- Construir botons de fÃ³rmules ----------------
function buildFormulaButtons(){
  formulaButtonsDiv.innerHTML = '';

  // Botons activitats
  classActivities.forEach(aid=>{
    db.collection('activitats').doc(aid).get().then(doc=>{
      const name = doc.exists ? doc.data().nom : '???';
      const btn = document.createElement('button');
      btn.type='button';
      btn.className='px-2 py-1 m-1 bg-indigo-200 rounded hover:bg-indigo-300';
      btn.textContent = name;
      btn.addEventListener('click', ()=> addToFormula(name));
      formulaButtonsDiv.appendChild(btn);
    });
  });

  // Botons operadors
  ['+', '-', '*', '/', '(', ')'].forEach(op=>{
    const btn = document.createElement('button');
    btn.type='button';
    btn.className='px-2 py-1 m-1 bg-gray-200 rounded hover:bg-gray-300';
    btn.textContent = op;
    btn.addEventListener('click', ()=> addToFormula(op));
    formulaButtonsDiv.appendChild(btn);
  });

  // Botons nÃºmeros 0-10
  for(let i=0;i<=10;i++){
    const btn = document.createElement('button');
    btn.type='button';
    btn.className='px-2 py-1 m-1 bg-green-200 rounded hover:bg-green-300';
    btn.textContent = i;
    btn.addEventListener('click', ()=> addToFormula(i));
    formulaButtonsDiv.appendChild(btn);
  }

  // Botons decimals
  ['.', ','].forEach(dec=>{
    const btn = document.createElement('button');
    btn.type='button';
    btn.className='px-2 py-1 m-1 bg-yellow-200 rounded hover:bg-yellow-300';
    btn.textContent = dec;
    btn.addEventListener('click', ()=> addToFormula('.')); // sempre converteix ',' a '.'
    formulaButtonsDiv.appendChild(btn);
  });

  // BotÃ³ Backspace
  const backBtn = document.createElement('button');
  backBtn.type='button';
  backBtn.className='px-2 py-1 m-1 bg-red-200 rounded hover:bg-red-300';
  backBtn.textContent = 'âŒ«';
  backBtn.addEventListener('click', ()=> formulaField.value = formulaField.value.slice(0,-1));
  formulaButtonsDiv.appendChild(backBtn);
}

// Afegir a formula
function addToFormula(str){
  formulaField.value += str;
}

function buildRoundingButtons(){
  formulaButtonsDiv.innerHTML = '';

  // Botons activitats
  classActivities.forEach(aid=>{
    db.collection('activitats').doc(aid).get().then(doc=>{
      const name = doc.exists ? doc.data().nom : '???';
      const btn = document.createElement('button');
      btn.type='button';
      btn.className='px-2 py-1 m-1 bg-indigo-200 rounded hover:bg-indigo-300';
      btn.textContent = name;
      btn.addEventListener('click', ()=> addToFormula(name)); // el nom de l'activitat
      formulaButtonsDiv.appendChild(btn);
    });
  });

  // BotÃ³ Backspace
  const backBtn = document.createElement('button');
  backBtn.type='button';
  backBtn.className='px-2 py-1 m-1 bg-red-200 rounded hover:bg-red-300';
  backBtn.textContent = 'âŒ«';
  backBtn.addEventListener('click', ()=> formulaField.value = formulaField.value.slice(0,-1));
  formulaButtonsDiv.appendChild(backBtn);

  // Botons 0.5 i 1
  [0.5,1].forEach(v=>{
    const btn = document.createElement('button');
    btn.type='button';
    btn.className='px-2 py-1 m-1 bg-green-200 rounded hover:bg-green-300';
    btn.textContent = v;
    btn.addEventListener('click', ()=> addToFormula(v)); // afegim directament 0.5 o 1
    formulaButtonsDiv.appendChild(btn);
  });
}


// ---------------- Evaluar fÃ³rmula ----------------
async function evalFormulaAsync(formula, studentId){
  let evalStr = formula;

  // Primer carreguem totes les notes de l'alumne
  const studentDoc = await db.collection('alumnes').doc(studentId).get();
  const notes = studentDoc.exists ? studentDoc.data().notes || {} : {};

  // 1) Substituir marcadors per ID (ex: __ACT__<actId>)
  for(const aid of classActivities){
    const marker = `__ACT__${aid}`;
    const val = Number(notes[aid]);
    const safeVal = isNaN(val) ? 0 : val;
    const reMarker = new RegExp(marker.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
    evalStr = evalStr.replace(reMarker, safeVal);
  }

  // 2) Substituir noms d'activitat per valors (compatibilitat amb fÃ³rmules antigues)
  for(const aid of classActivities){
    const actDoc = await db.collection('activitats').doc(aid).get();
    const actName = actDoc.exists ? actDoc.data().nom : '';
    if(!actName) continue;
    const val = Number(notes[aid]);
    const safeVal = isNaN(val) ? 0 : val;

    const regex = new RegExp(actName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
    evalStr = evalStr.replace(regex, safeVal);
  }

  try {
    return Function('"use strict"; return (' + evalStr + ')')();
  } catch(e){
    console.error('Error evaluating formula:', formula, e);
    return 0;
  }
}






// ---------------- Helper per trobar nom alumne per ID ----------------
function getStudentRowById(sid) {
  // Busca la fila corresponent a aquest studentId
  const studentIndex = classStudents.findIndex(id => id === sid);
  if (studentIndex === -1) return null;
  return notesTbody.children[studentIndex] || null;
}

/* ---------------- Drag & Drop per activitats ---------------- */
function enableActivityDrag(){
  const ths = notesThead.querySelectorAll('tr:first-child th');
  ths.forEach((thEl, idx)=>{
    if(idx === 0 || idx === ths.length-1) return; // No draggable: primera (Alumne) i Ãºltima (Mitjana)
    
    thEl.setAttribute('draggable', true);
    thEl.addEventListener('dragstart', e=>{
      e.dataTransfer.setData('text/plain', idx);
    });

    thEl.addEventListener('dragover', e=>{
      e.preventDefault();
      thEl.classList.add('border-dashed', 'border-2');
    });

    thEl.addEventListener('dragleave', e=>{
      thEl.classList.remove('border-dashed', 'border-2');
    });

    thEl.addEventListener('drop', e=>{
      e.preventDefault();
      thEl.classList.remove('border-dashed', 'border-2');
      const fromIdx = Number(e.dataTransfer.getData('text/plain'));
      const toIdx = idx;

      if(fromIdx === toIdx) return;

      // Reordenar classActivities
      const arr = Array.from(classActivities);
      const moved = arr.splice(fromIdx-1, 1)[0]; // -1 per ignorar columna Alumne
      arr.splice(toIdx-1, 0, moved);
      classActivities = arr;

      // ðŸ”¥ Guardar el nou ordre a Firestore
      if(currentClassId){
  const path = `terms.${Terms.getActiveTerm()}.activities`;
  db.collection('classes').doc(currentClassId).update({ [path]: classActivities })
    .then(() => console.log('Ordre dâ€™activitats actualitzat a Firestore'))
    .catch(e => console.error('Error guardant ordre activitats', e));
}


      renderNotesGrid();
    });
  });
}


/* ---------------- Marcar activitat com calculada ---------------- */
async function markActivityAsCalculated(activityId){
  if(!currentClassId) return;
  await db.collection('classes').doc(currentClassId).update({
    [`calculatedActivities.${activityId}`]: true
  });
  // Re-render per assegurar bloqueig i color
  renderNotesGrid();
}



/* ---------------- Export Excel ---------------- */
btnExport.addEventListener('click', exportExcel);
async function exportExcel(){
  if(!currentClassId) return alert('No hi ha cap classe seleccionada.');

  try {
    // Carregar informaciÃ³ de la classe
    const classDoc = await db.collection('classes').doc(currentClassId).get();
    if(!classDoc.exists) return alert('Classe no trobada.');
    const classData = classDoc.data();

    // Carregar activitats
    const actDocs = await Promise.all(classActivities.map(id => db.collection('activitats').doc(id).get()));

    // Carregar alumnes
    const studentDocs = await Promise.all(classStudents.map(id => db.collection('alumnes').doc(id).get()));

    const ws_data = [];

    // CapÃ§alera
    const header = ['Alumne', ...actDocs.map(a => a.exists ? a.data().nom : 'Sense nom'), 'Mitjana'];
    ws_data.push(header);

    // Files alumnes
    studentDocs.forEach(sdoc => {
      const notes = sdoc.exists ? sdoc.data().notes || {} : {};
      const row = [sdoc.exists ? sdoc.data().nom : 'Desconegut'];

      let sum = 0, count = 0;

      actDocs.forEach(adoc => {
        const aid = adoc.id;
        const val = (notes[aid] !== undefined) ? Number(notes[aid]) : '';
        row.push(val);
        if(val !== '') { sum += val; count++; }
      });

      row.push(count ? (sum/count).toFixed(2) : '');
      ws_data.push(row);
    });

    // Crear llibre Excel i full
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, 'Notes');

    // Nom del fitxer
    const fname = (document.getElementById('classTitle').textContent || 'classe') + '.xlsx';
    XLSX.writeFile(wb, fname);

  } catch(e){
    console.error(e);
    alert('Error exportant Excel: ' + e.message);
  }
}


/* ---------------- Tancar menÃºs si fas clic fora ---------------- */
document.addEventListener('click', function(e) {
  document.querySelectorAll('.menu').forEach(menu => {
    if (!menu.contains(e.target) && !e.target.classList.contains('menu-btn')) {
      menu.classList.add('hidden');
    }
  });
});
const userMenuBtn = document.getElementById('userMenuBtn');
const userMenu = document.getElementById('userMenu');
const changePasswordBtn = document.getElementById('changePasswordBtn');

// Toggle menÃº
userMenuBtn.addEventListener('click', e => {
  e.stopPropagation();
  userMenu.classList.toggle('hidden');
});

// Tancar menÃº si clics fora
document.addEventListener('click', () => {
  userMenu.classList.add('hidden');
});

// Canviar contrasenya
changePasswordBtn.addEventListener('click', () => {
  const email = auth.currentUser?.email;
  if(!email) return alert('No hi ha usuari actiu.');
  const newPw = prompt('Introdueix la nova contrasenya:');
  if(!newPw) return;
  auth.currentUser.updatePassword(newPw)
    .then(()=> alert('Contrasenya canviada correctament!'))
    .catch(e=> alert('Error: ' + e.message));
});

// ---------------------- Importar alumnes ------------------------
document.getElementById('btnImportALConfirm').addEventListener('click', () => {
  const fileInput = document.getElementById('fileImport');
  const file = fileInput.files[0];
  if (!file) return alert("Selecciona un fitxer!");

  const reader = new FileReader();
  reader.onload = async (e) => {
    let data = e.target.result;
    let studentNames = [];

    // Llegir CSV
    if (file.name.endsWith('.csv')) {
      const lines = data.split(/\r?\n/);
      lines.forEach(line => {
        const name = line.trim();
        if (name) studentNames.push(name);
      });
    } 
    // Llegir XLSX
    else if (file.name.endsWith('.xlsx')) {
      const workbook = XLSX.read(data, { type: 'binary' });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
      json.forEach(row => {
        const name = row[0];
        if (name) studentNames.push(name.trim());
      });
    }

    if(studentNames.length === 0) return alert('No sâ€™ha trobat cap alumne al fitxer.');

    // Cridar funciÃ³ per afegir alumnes a Firestore i classe
    await addImportedStudents(studentNames);

    closeModal('modalImportAL');
  };

  if (file.name.endsWith('.xlsx')) reader.readAsBinaryString(file);
  else reader.readAsText(file);
});

// FunciÃ³ per afegir alumnes a Firestore i a la classe
async function addImportedStudents(names) {
  if (!currentClassId) return alert('No hi ha cap classe seleccionada.');

  const classRef = db.collection('classes').doc(currentClassId);

  try {
    for (const name of names) {
      const studentRef = db.collection('alumnes').doc();
      // Crear alumne a Firestore
      await studentRef.set({ nom: name, notes: {} });
      // Afegir ID alumne a la classe
      await classRef.update({
        alumnes: firebase.firestore.FieldValue.arrayUnion(studentRef.id)
      });
    }

    // Recarregar la graella perquÃ¨ apareguin amb menÃº i drag & drop
    loadClassData();

    alert(`${names.length} alumne(s) importat(s) correctament!`);
  } catch(e) {
    console.error(e);
    alert('Error afegint alumnes: ' + e.message);
  }
}

// --------------BotÃ³ per tancar la llista d'alumnes mÃ²bil
const closeBtn = document.getElementById('closeStudentsMobile');
if (closeBtn) {
  closeBtn.addEventListener('click', () => {
    const container = document.getElementById('studentsListContainer');
    container.classList.remove('mobile-open');
  });
}

// ----------------------Fer funcionar el botÃ³ + (afegir terme)
const btnAddTerm = document.getElementById('btnAddTerm');
btnAddTerm.addEventListener('click', async () => {
  const name = prompt('Nom del nou grup (p. ex. 2TRIM):');
  if(!name) return;
  try {
    const newId = await Terms.addNewTermWithName(name);
    // Quan acaba, Terms ja cridarÃ  l'onChange que actualitza la graella i el dropdown
  } catch(e) {
    console.error('Error creant terme:', e);
    alert('Error creant terme: ' + e.message);
  }
});

// BotÃ³ de menÃº de graella
const termMenuBtn = document.getElementById('termMenuBtn');
const termMenu = document.getElementById('termMenu');

termMenuBtn.addEventListener('click', e => {
  e.stopPropagation();
  termMenu.classList.toggle('hidden');
});

// Tancar menÃº si clicques fora
document.addEventListener('click', () => {
  termMenu.classList.add('hidden');
});

// Editar nom de graella
termMenu.querySelector('.edit-term-btn').addEventListener('click', async () => {
  const currentTermId = Terms.getActiveTermId();
  const currentName = Terms.getActiveTermName();
  const newName = prompt('Nou nom de la graella:', currentName);
  if (newName && newName.trim() !== '') {
    await Terms.renameTerm(currentTermId, newName.trim());
  }
  termMenu.classList.add('hidden');
});

// Eliminar graella
termMenu.querySelector('.delete-term-btn').addEventListener('click', async () => {
  const currentTermId = Terms.getActiveTermId();
  if (!currentTermId) return;
  if (!confirm('Segur que vols eliminar aquesta graella i totes les seves activitats?')) return;

  try {
    await Terms.deleteTerm(currentTermId); // <-- AquÃ­ utilitzem la funciÃ³ de terms.js
  } catch(e) {
    alert('Error eliminant graella: ' + e.message);
  }

  termMenu.classList.add('hidden');
});

// Copiar estructura
termMenu.querySelector('.copy-structure-btn').addEventListener('click', () => {
  const currentTermId = Terms.getActiveTermId();
  if (!currentTermId) return;
  Terms.copyGridStructure(currentTermId);
  alert('Estructura copiada!');
  termMenu.classList.add('hidden');
});

// Enganxar estructura
termMenu.querySelector('.paste-structure-btn').addEventListener('click', async () => {
  const currentTermId = Terms.getActiveTermId();
  if (!currentTermId) return;

  await Terms.pasteGridStructure(currentTermId);
  alert('Estructura enganxada a la graella!');
  termMenu.classList.add('hidden');
});



//----------------------activar eliminar estudiants--------------------
function activateDeleteStudentsMode() {
    studentsMenu.classList.add('hidden');

    // Afegim el checkbox a cada alumne
    document.querySelectorAll('#studentsList li').forEach(li => {
        // Agafem la columna on hi ha el menÃº â‹®
        const menuContainer = li.querySelector('.relative');

        // Amaguem el menÃº â‹®
        const menuBtn = li.querySelector('.menu-btn');
        if (menuBtn) menuBtn.style.display = 'none';

        // Creem el checkbox i lâ€™afegim DINS del mateix container a la dreta
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'stu-check ml-2'; // ml-2: marge a lâ€™esquerra del checkbox
        menuContainer.appendChild(checkbox);
    });

    // Afegim menÃº inferior
    const footer = document.createElement('div');
    footer.id = 'studentsDeleteFooter';
    footer.className = 'mt-3 p-2 bg-red-50 border border-red-200 rounded flex justify-between items-center';

    footer.innerHTML = `
        <div>
            <label><input type="checkbox" id="selectAllStudents"> Tots</label>
        </div>
        <button id="confirmDeleteStudents" class="bg-red-600 text-white px-3 py-1 rounded">
            Eliminar
        </button>
    `;

    document.getElementById('studentsList').after(footer);

    // Select all
    document.getElementById('selectAllStudents').addEventListener('change', e => {
        document.querySelectorAll('.stu-check').forEach(ch => ch.checked = e.target.checked);
    });

    // BotÃ³ eliminar seleccionats
    document.getElementById('confirmDeleteStudents').addEventListener('click', () => {
        deleteSelectedStudents();
    });
}

//----------------------funcio eliminar seleccionats--------------------
function deleteSelectedStudents() {
    const selected = [...document.querySelectorAll('.stu-check:checked')];

    if (selected.length === 0) {
        alert('No hi ha alumnes seleccionats.');
        return;
    }

    if (!confirm(`Eliminar ${selected.length} alumnes?`)) return;

    const ids = [];

    selected.forEach(ch => {
        const li = ch.closest('li');
        const stuName = li.querySelector('.stu-name').textContent;

        // Agafem ID per eliminar-lo de la classe
        const index = [...studentsList.children].indexOf(li);
        const stuId = classStudents[index];

        ids.push(stuId);
    });

    // Actualitzar Firestore
    const classRef = db.collection('classes').doc(currentClassId);

    classRef.update({
        alumnes: firebase.firestore.FieldValue.arrayRemove(...ids)
    }).then(() => {
        // Tornem a carregar
        loadClassData();
        exitDeleteStudentsMode();
    });
}

//---------------sortit mode eliminacio----------------------------
function exitDeleteStudentsMode() {
    const footer = document.getElementById('studentsDeleteFooter');
    if (footer) footer.remove();

    // Treure els checkbox del costat dels alumnes
    document.querySelectorAll('.stu-check').forEach(ch => ch.remove());

    // Mostrar els â‹® de cada alumne
    document.querySelectorAll('#studentsList li .menu-btn').forEach(btn => {
        btn.style.display = 'inline-block';
    });
}

//-----------------------control del mode eliminar
function toggleDeleteStudentsMode() {
    isDeleteMode = !isDeleteMode;

    classStudents.forEach(stuId => {
        const li = document.querySelector(`li[data-student-id="${stuId}"]`);
        if (!li) return;

        const menuBtn = li.querySelector('.menu-btn');

        if (isDeleteMode) {
            // Amaga â‹® individuals
            if (menuBtn) menuBtn.style.display = 'none';

            // Afegir checkbox si no existeix
            if (!li.querySelector('.stu-check')) {
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'stu-check ml-2';
                li.querySelector('.relative').appendChild(checkbox);
            }
        } else {
            // Tornar a mostrar â‹®
            if (menuBtn) menuBtn.style.display = 'inline-block';

            // Eliminar checkboxes
            const checkbox = li.querySelector('.stu-check');
            if (checkbox) checkbox.remove();
        }
    });

    // Mostrar/Amagar botÃ³ CancelÂ·lar a la capÃ§alera
    const cancelBtn = document.getElementById('cancelDeleteStudentsBtn');
    if (cancelBtn) cancelBtn.style.display = isDeleteMode ? 'inline-block' : 'none';
}

// Premem els tres puntets â†’ mode eliminar
document.getElementById('deleteStudentsModeBtn').addEventListener('click', () => {
    toggleDeleteStudentsMode(); // aquÃ­ entres al mode eliminar
});

// Premem CancelÂ·lar â†’ surt del mode
document.getElementById('cancelDeleteStudentsBtn').addEventListener('click', () => {
    exitDeleteStudentsMode();
    isDeleteMode = false; // actualitza l'estat del mode
    document.getElementById('cancelDeleteStudentsBtn').style.display = 'none'; // amaga el botÃ³
});

// ----------- SCRIPT PER MARCAR USUARIS COM A ADMIN -----------

// Llista d'usuaris que vols marcar com a administrador
const adminEmails = [
  "toni.munoz@institutmatadepera.cat",
  "tonaco92@gamil.com",
  "el_teu_email@exemple.com" // posa el teu email
];

// FunciÃ³ per actualitzar Firestore
async function setAdmins() {
  try {
    const snapshot = await db.collection('professors').get();
    snapshot.forEach(doc => {
      const data = doc.data();
      if (adminEmails.includes(data.email)) {
        db.collection('professors').doc(doc.id).update({ isAdmin: true })
          .then(() => console.log(`Usuari ${data.email} marcat com admin.`))
          .catch(err => console.error('Error actualitzant:', err));
      }
    });
  } catch (err) {
    console.error('Error llegint professors:', err);
  }
}

// Executar nomÃ©s una vegada
setAdmins();

//----------------nou
function filterStudentsList() {
  const text = studentSearch.value.toLowerCase();

  document.querySelectorAll('#studentsList li').forEach(li => {
    const name = li.querySelector('.stu-name')?.innerText.toLowerCase() || "";
    li.style.display = name.includes(text) ? "" : "none";
  });
}

/* ---------------------- MODE ENVIAR NOTES ---------------------- */
window.__sendNotesModeActive = false;

// Afegim lâ€™opciÃ³ al menÃº global dels alumnes
(function attachGlobalStudentsMenuOption(){
  const studentsMenu = document.getElementById('studentsMenu');
  if (!studentsMenu) return;

  if (!studentsMenu.querySelector('.send-notes-mode-btn')) {
    const btn = document.createElement('button');
    btn.className = 'send-notes-mode-btn px-3 py-1 w-full text-left hover:bg-gray-100';
    btn.textContent = 'Enviar notes';
    btn.addEventListener('click', () => {
      toggleSendNotesMode();
      studentsMenu.classList.add('hidden');
    });
    studentsMenu.appendChild(btn);
  }
})();

// -------------------- FUNCIONS DE MODE ENVIAR NOTES --------------------
window.__sendNotesModeActive = false;

// Afegim lâ€™opciÃ³ al menÃº global dels alumnes
(function attachGlobalStudentsMenuOption(){
  const studentsMenu = document.getElementById('studentsMenu');
  if (!studentsMenu) return;

  if (!studentsMenu.querySelector('.send-notes-mode-btn')) {
    const btn = document.createElement('button');
    btn.className = 'send-notes-mode-btn px-3 py-1 w-full text-left hover:bg-gray-100';
    btn.textContent = 'Enviar notes';
    btn.addEventListener('click', () => {
      toggleSendNotesMode();
      studentsMenu.classList.add('hidden');
    });
    studentsMenu.appendChild(btn);
  }
})();

// -------------------- FUNCIONS DE MODE ENVIAR NOTES --------------------
function toggleSendNotesMode() {
  window.__sendNotesModeActive = !window.__sendNotesModeActive;

  if (window.__sendNotesModeActive) {
    showSendModeCheckboxes();
    showSendSelectedButton();
    showExitSendNotesButton();
  } else {
    hideSendModeCheckboxes();
    hideSendSelectedButton();
    hideExitSendNotesButton();
  }
}

// Mostrar checkboxes a la dreta (al lloc dels tres puntets) i amagar els tres puntets
function showSendModeCheckboxes() {
  document.querySelectorAll('#studentsList li').forEach(li => {
    if (li.querySelector('.send-note-checkbox')) return;

    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.className = 'send-note-checkbox';
    cb.style.marginLeft = '8px';
    cb.style.marginRight = '0';
    cb.style.cursor = 'pointer';

    // Amaguem els tres puntets
    const menuBtn = li.querySelector('.menu-btn');
    if (menuBtn) menuBtn.style.display = 'none';

    // Afegim el checkbox a la dreta
    const rightDiv = li.querySelector('div.relative');
    rightDiv.insertBefore(cb, rightDiv.firstChild);
  });
}

// Amagar checkboxes i tornar a mostrar els tres puntets
function hideSendModeCheckboxes() {
  document.querySelectorAll('.send-note-checkbox').forEach(cb => {
    const li = cb.closest('li');
    const menuBtn = li.querySelector('.menu-btn');
    if (menuBtn) menuBtn.style.display = '';
    cb.remove();
  });
}

// BotÃ³ global "Enviar notes seleccionades"
function showSendSelectedButton() {
  const container = document.getElementById('studentsListContent');
  if (!container) return;
  if (document.getElementById('btnSendSelectedNotes')) return;

  const btn = document.createElement('button');
  btn.id = 'btnSendSelectedNotes';
  btn.className = 'mt-2 w-full bg-blue-600 text-white px-3 py-2 rounded';
  btn.textContent = 'Enviar notes seleccionades';
  btn.addEventListener('click', sendSelectedNotes);

  container.insertBefore(btn, document.getElementById('studentsList'));
}

function hideSendSelectedButton() {
  document.getElementById('btnSendSelectedNotes')?.remove();
}

// BotÃ³ "X vermella" per sortir del mode enviar notes
/*function showExitSendNotesButton() {
  const container = document.getElementById('studentsListContent');
  if (!container) return;
  if (document.getElementById('btnExitSendNotes')) return;

  const btn = document.createElement('button');
  btn.id = 'btnExitSendNotes';
  btn.className = 'absolute right-4 top-2 text-white bg-red-600 rounded-full w-6 h-6 flex items-center justify-center cursor-pointer';
  btn.textContent = 'Ã—';
  btn.title = 'Sortir del mode enviar notes';
  btn.addEventListener('click', toggleSendNotesMode);

  container.appendChild(btn);
}*/

function showExitSendNotesButton() {
  const menuContainer = document.querySelector('#studentsListContent .flex.items-center.justify-between .relative');
  if (!menuContainer) return;
  if (document.getElementById('btnExitSendNotes')) return;

  // Assegura que el container sigui flex horitzontal
  menuContainer.style.display = 'flex';
  menuContainer.style.alignItems = 'center';
  menuContainer.style.gap = '4px'; // una mica d'espai entre la X i els tres puntets

  const btn = document.createElement('button');
  btn.id = 'btnExitSendNotes';
  btn.className = 'text-white bg-red-600 rounded-full w-6 h-6 flex items-center justify-center cursor-pointer';
  btn.textContent = 'Ã—';
  btn.title = 'Sortir del mode enviar notes';
  btn.addEventListener('click', toggleSendNotesMode);

  const menuBtn = menuContainer.querySelector('#studentsMenuBtn');
  menuContainer.insertBefore(btn, menuBtn); // Ara quedarÃ  just a l'esquerra dels tres puntets
}


function hideExitSendNotesButton() {
  document.getElementById('btnExitSendNotes')?.remove();
}


// FunciÃ³ per formatar les notes dâ€™un alumne per enviar per mail------------------------------

async function formatStudentNotesForEmail(studentId) {
  const doc = await db.collection('alumnes').doc(studentId).get();
  if (!doc.exists) return 'No hi ha dades.';

  const data = doc.data();
  const notes = data.notes || {};

  let lines = [];

  for (const actId of classActivities) {
    let actName = actId;

    try {
      const aDoc = await db.collection('activitats').doc(actId).get();
      if (aDoc.exists) actName = aDoc.data().nom || actId;
    } catch {}

    const val = notes[actId] ?? '';
    lines.push(`${actName}: ${val}`);
  }

  if (typeof computeStudentAverageText === "function") {
    lines.push(`Mitjana: ${computeStudentAverageText(data)}`);
  }

  return lines.join('\n');
}

//-------Enviar notes seleccionades
async function sendSelectedNotes() {
  const checked = [...document.querySelectorAll('.send-note-checkbox:checked')];
  if (!checked.length) {
    alert("Selecciona algun alumne.");
    return;
  }

  for (const cb of checked) {
    const li = cb.closest('li');
    const studentId = li.dataset.studentId;

    let email = li.dataset.email || '';

    // Si no hi ha email â†’ demanar-lo
    if (!email) {
      const newMail = prompt(`Email per ${li.querySelector('.stu-name').textContent}:`);
      if (!newMail) continue;

      email = newMail.trim();
      li.dataset.email = email;

      await db.collection('alumnes').doc(studentId).update({ email });
    }

    const body = await formatStudentNotesForEmail(studentId);
    const subject = `Notes de ${li.querySelector('.stu-name').textContent}`;

    await gmailSendEmail(email, subject, body);


    await new Promise(r => setTimeout(r, 200));
  }
}

//-----------FunciÃ³ per ENVIAR MAIL directament des del Gmail de lâ€™usuari----------------
async function gmailSendEmail(to, subject, message) {
  if (!window._googleAccessToken) {
    alert("Cal iniciar sessiÃ³ amb Google per enviar mails.");
    return;
  }

  const email = [
    `To: ${to}`,
    `Subject: ${subject}`,
    "",
    message
  ].join("\n");

  const base64Email = btoa(unescape(encodeURIComponent(email)))
    .replace(/\+/g, '-')
    .replace(/\//g, '_')
    .replace(/=+$/, '');

  try {
    const response = await fetch(
      "https://gmail.googleapis.com/gmail/v1/users/me/messages/send",
      {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${window._googleAccessToken}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ raw: base64Email })
      }
    );

    if (!response.ok) {
      const errorText = await response.text();
      console.error(errorText);
      alert("Error enviant el correu: " + errorText);
      return;
    }

    alert(`Correu enviat a ${to} correctament!`);
    return true;
  } catch (err) {
    console.error(err);
    alert("Error enviant el correu: " + err.message);
  }
}

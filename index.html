<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini Gestor de Notes Modern</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- XLSX -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
.table-input { width:3.5rem; }
.modal-backdrop { background: rgba(0,0,0,0.45); backdrop-filter: blur(3px); }
.fade-in { animation: fadeIn .15s ease-out; }
@keyframes fadeIn { from {opacity:0; transform: translateY(-6px)} to {opacity:1; transform: translateY(0)} }
.card-hover { transition: transform 0.2s, box-shadow 0.2s; }
.card-hover:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
</style>
</head>
<body class="bg-gray-100 text-gray-800">

<!-- ---------------- LOGIN SCREEN ---------------- -->
<div id="loginScreen" class="flex flex-col justify-center items-center min-h-screen bg-gradient-to-r from-purple-500 to-indigo-600 text-white">
  <div class="bg-white text-gray-800 p-8 rounded-xl shadow-2xl w-80 md:w-96 flex flex-col items-center space-y-5">
    <img src="https://img.icons8.com/ios-filled/100/000000/school.png" alt="Logo" class="w-28 h-28 mb-2">
    <h1 class="text-3xl font-bold text-center">Mini Gestor de Notes</h1>
    <input type="email" id="email" placeholder="Email" class="border rounded p-2 w-full focus:outline-none focus:ring-2 focus:ring-indigo-500">
    <input type="password" id="password" placeholder="Contrasenya" class="border rounded p-2 w-full focus:outline-none focus:ring-2 focus:ring-indigo-500">
    <button id="btnLogin" class="bg-indigo-600 hover:bg-indigo-700 w-full py-2 rounded text-white font-semibold shadow">Login</button>
    <button id="btnRegister" class="bg-green-500 hover:bg-green-600 w-full py-2 rounded text-white font-semibold shadow">Registrar</button>
    <button id="btnRecover" class="text-indigo-700 underline text-sm hover:text-indigo-900">He oblidat la contrasenya</button>
  </div>
</div>

<!-- ---------------- CLASSES SCREEN ---------------- -->
<div id="classesScreen" class="hidden max-w-6xl mx-auto p-6 min-h-screen">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-3xl font-bold">Les meves classes</h2>
    <div class="flex items-center gap-4">
      <span id="userName" class="font-semibold text-lg"></span>
      <button id="btnLogout" class="bg-red-500 hover:bg-red-600 text-white py-1 px-4 rounded shadow">Logout</button>
    </div>
  </div>
  <div class="flex gap-4 mb-6">
    <button id="btnCreateClass" class="bg-indigo-500 hover:bg-indigo-700 text-white py-2 px-5 rounded shadow">➕ Crear classe</button>
    <button id="btnRefreshClasses" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-5 rounded shadow">Refrescar</button>
  </div>
  <div id="classesGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>
</div>

<!-- ---------------- CLASS SCREEN ---------------- -->
<div id="classScreen" class="hidden max-w-6xl mx-auto p-6">
  <div class="flex justify-between items-center mb-4">
    <button id="btnBack" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded shadow">← Tornar</button>
    <h2 id="classTitle" class="text-3xl font-bold"></h2>
    <div class="flex gap-2">
      <button id="btnAddStudent" class="bg-purple-500 hover:bg-purple-700 text-white px-3 py-1 rounded shadow">➕ Alumne</button>
      <button id="btnAddActivity" class="bg-teal-500 hover:bg-teal-700 text-white px-3 py-1 rounded shadow">➕ Activitat</button>
      <button id="btnExport" class="bg-yellow-400 hover:bg-yellow-500 px-3 py-1 rounded shadow">Exportar Excel</button>
    </div>
  </div>

  <div class="overflow-x-auto bg-white rounded shadow p-4">
    <table id="notesTable" class="min-w-full border-collapse">
      <thead id="notesThead" class="bg-gray-100"></thead>
      <tbody id="notesTbody"></tbody>
      <tfoot id="notesTfoot" class="bg-gray-50"></tfoot>
    </table>
  </div>
</div>

<!-- ---------------- MODALS ---------------- -->
<!-- Create Class Modal -->
<div id="modalCreateClass" class="fixed inset-0 hidden items-center justify-center z-50">
  <div class="modal-backdrop absolute inset-0"></div>
  <div class="bg-white rounded-xl shadow-lg z-10 w-full max-w-md p-5 fade-in">
    <h3 class="text-xl font-semibold mb-3">Crear nova classe</h3>
    <input id="modalClassName" class="border rounded px-3 py-2 w-full mb-3 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Nom de la classe">
    <div class="flex justify-end gap-3">
      <button onclick="closeModal('modalCreateClass')" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">Cancel·lar</button>
      <button onclick="createClassModal()" class="px-3 py-1 rounded bg-indigo-600 hover:bg-indigo-700 text-white">Crear</button>
    </div>
  </div>
</div>

<!-- Add Student Modal -->
<div id="modalAddStudent" class="fixed inset-0 hidden items-center justify-center z-50">
  <div class="modal-backdrop absolute inset-0"></div>
  <div class="bg-white rounded-xl shadow-lg z-10 w-full max-w-md p-5 fade-in">
    <h3 class="text-xl font-semibold mb-3">Afegir alumne</h3>
    <input id="modalStudentName" class="border rounded px-3 py-2 w-full mb-3 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Nom de l'alumne">
    <div class="flex justify-end gap-3">
      <button onclick="closeModal('modalAddStudent')" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">Cancel·lar</button>
      <button onclick="createStudentModal()" class="px-3 py-1 rounded bg-purple-600 hover:bg-purple-700 text-white">Afegir</button>
    </div>
  </div>
</div>

<!-- Add Activity Modal -->
<div id="modalAddActivity" class="fixed inset-0 hidden items-center justify-center z-50">
  <div class="modal-backdrop absolute inset-0"></div>
  <div class="bg-white rounded-xl shadow-lg z-10 w-full max-w-md p-5 fade-in">
    <h3 class="text-xl font-semibold mb-3">Afegir activitat</h3>
    <input id="modalActivityName" class="border rounded px-3 py-2 w-full mb-3 focus:outline-none focus:ring-2 focus:ring-teal-500" placeholder="Nom de l'activitat">
    <div class="flex justify-end gap-3">
      <button onclick="closeModal('modalAddActivity')" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">Cancel·lar</button>
      <button onclick="createActivityModal()" class="px-3 py-1 rounded bg-teal-600 hover:bg-teal-700 text-white">Afegir</button>
    </div>
  </div>
</div>

<!-- Confirm Modal -->
<div id="modalConfirm" class="fixed inset-0 hidden items-center justify-center z-50">
  <div class="modal-backdrop absolute inset-0"></div>
  <div class="bg-white rounded-xl shadow-lg z-10 w-full max-w-sm p-5 fade-in">
    <h3 id="confirmTitle" class="text-xl font-semibold mb-3">Confirmació</h3>
    <p id="confirmMsg" class="text-sm text-gray-600 mb-4"></p>
    <div class="flex justify-end gap-3">
      <button onclick="closeModal('modalConfirm')" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">Cancel·lar</button>
      <button id="confirmYes" class="px-3 py-1 rounded bg-red-600 hover:bg-red-700 text-white">Sí, eliminar</button>
    </div>
  </div>
</div>

<!-- ---------------- JAVASCRIPT COMPLET ---------------- -->
<script>
/* ---------------- FIREBASE CONFIG ---------------- */
const firebaseConfig = {
  apiKey: "AQUÍ_EL_TEU_API_KEY",
  authDomain: "AQUÍ_EL_TEU_AUTH_DOMAIN",
  projectId: "AQUÍ_EL_TEU_PROJECT_ID",
  storageBucket: "AQUÍ_EL_TEU_STORAGE_BUCKET",
  messagingSenderId: "AQUÍ_EL_TEU_MESSAGING_SENDER_ID",
  appId: "AQUÍ_EL_TEU_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ---------------- VARIABLES ---------------- */
let professorUID = null;
let currentClassId = null;
let classStudents = [];
let classActivities = [];

/* ---------------- ELEMENTS ---------------- */
const loginScreen = document.getElementById('loginScreen');
const classesScreen = document.getElementById('classesScreen');
const classScreen = document.getElementById('classScreen');
const classesGrid = document.getElementById('classesGrid');
const userNameDisplay = document.getElementById('userName');

/* ---------------- LOGIN & REGISTER ---------------- */
document.getElementById('btnLogin').addEventListener('click', ()=> {
  const email = document.getElementById('email').value.trim();
  const pw = document.getElementById('password').value;
  auth.signInWithEmailAndPassword(email,pw)
    .then(u => {
      professorUID = u.user.uid;
      userNameDisplay.textContent = email.split('@')[0];
      showClassesScreen();
    })
    .catch(e => alert('Error login: '+e.message));
});

document.getElementById('btnRegister').addEventListener('click', ()=> {
  const email = document.getElementById('email').value.trim();
  const pw = document.getElementById('password').value;
  auth.createUserWithEmailAndPassword(email,pw)
    .then(u => {
      professorUID = u.user.uid;
      db.collection('professors').doc(professorUID).set({ email, classes: [] })
        .then(()=> {
          userNameDisplay.textContent = email.split('@')[0];
          showClassesScreen();
        });
    })
    .catch(e => alert('Error registre: '+e.message));
});

document.getElementById('btnRecover').addEventListener('click', ()=> {
  const email = document.getElementById('email').value.trim();
  if(!email) { alert('Escriu el teu email'); return; }
  auth.sendPasswordResetEmail(email).then(()=> alert('Email enviat per restablir contrasenya')).catch(e=> alert(e.message));
});

document.getElementById('btnLogout').addEventListener('click', ()=> {
  auth.signOut().then(()=> location.reload());
});

/* ---------------- MODALS ---------------- */
function openModal(id){ const m=document.getElementById(id); m.classList.remove('hidden'); m.style.display='flex'; }
function closeModal(id){ const m=document.getElementById(id); m.classList.add('hidden'); m.style.display='none'; }
function confirmAction(title,msg,yesCallback){
  document.getElementById('confirmTitle').textContent=title;
  document.getElementById('confirmMsg').textContent=msg;
  openModal('modalConfirm');
  const yesBtn=document.getElementById('confirmYes');
  yesBtn.onclick=()=>{ closeModal('modalConfirm'); yesCallback(); };
}

/* ---------------- CLASSES ---------------- */
document.getElementById('btnCreateClass').addEventListener('click',()=> openModal('modalCreateClass'));
document.getElementById('btnRefreshClasses').addEventListener('click', loadClassesScreen);
document.getElementById('btnBack').addEventListener('click',()=>{
  currentClassId=null;
  classScreen.classList.add('hidden');
  showClassesScreen();
});

/* ---------------- STUDENTS & ACTIVITIES ---------------- */
document.getElementById('btnAddStudent').addEventListener('click',()=> openModal('modalAddStudent'));
document.getElementById('btnAddActivity').addEventListener('click',()=> openModal('modalAddActivity'));
document.getElementById('btnExport').addEventListener('click', exportExcel);

/* ---------------- FUNCIONS PRINCIPALS ---------------- */
function showClassesScreen(){ loginScreen.classList.add('hidden'); classScreen.classList.add('hidden'); classesScreen.classList.remove('hidden'); loadClassesScreen(); }

function loadClassesScreen(){
  if(!professorUID){ alert('Fes login primer'); return; }
  classesGrid.innerHTML = '<div class="col-span-full text-sm text-gray-500">Carregant...</div>';
  db.collection('professors').doc(professorUID).get().then(doc=>{
    if(!doc.exists){ classesGrid.innerHTML='<div class="text-sm text-red-500">Professor no trobat</div>'; return; }
    const ids = doc.data().classes || [];
    if(ids.length===0){ classesGrid.innerHTML='<div class="col-span-full p-6 bg-white rounded shadow text-center">No tens cap classe. Crea la primera!</div>'; return; }
    Promise.all(ids.map(id=> db.collection('classes').doc(id).get())).then(docs=>{
      classesGrid.innerHTML='';
      docs.forEach(d=>{
        if(!d.exists) return;
        const card=document.createElement('div');
        card.className='cursor-pointer p-5 rounded bg-white shadow card-hover';
        card.innerHTML=`<h3 class="text-lg font-bold mb-1">${d.data().nom||'Sense nom'}</h3>
                        <p class="text-sm text-gray-500">${(d.data().alumnes||[]).length} alumnes · ${(d.data().activitats||[]).length} activitats</p>
                        <div class="mt-3 text-xs text-indigo-600">Fes clic per obrir</div>`;
        card.addEventListener('click', ()=> openClass(d.id));
        classesGrid.appendChild(card);
      });
    });
  });
}

/* ---------------- CLASS ---------------- */
function openClass(id){ currentClassId=id; classesScreen.classList.add('hidden'); classScreen.classList.remove('hidden'); loadClassData(); }

function createClassModal(){
  const name=document.getElementById('modalClassName').value.trim();
  if(!name){ alert('Posa un nom'); return; }
  const ref=db.collection('classes').doc();
  ref.set({nom:name,alumnes:[],activitats:[]})
    .then(()=> db.collection('professors').doc(professorUID).update({classes:firebase.firestore.FieldValue.arrayUnion(ref.id)}))
    .then(()=> { closeModal('modalCreateClass'); document.getElementById('modalClassName').value=''; loadClassesScreen(); })
    .catch(e=> alert('Error: '+e.message));
}

function createStudentModal(){
  const name=document.getElementById('modalStudentName').value.trim();
  if(!name){ alert('Posa un nom'); return; }
  const ref=db.collection('alumnes').doc();
  ref.set({nom:name,notes:{}})
    .then(()=> db.collection('classes').doc(currentClassId).update({alumnes:firebase.firestore.FieldValue.arrayUnion(ref.id)}))
    .then(()=> { closeModal('modalAddStudent'); document.getElementById('modalStudentName').value=''; loadClassData(); })
    .catch(e=> alert('Error: '+e.message));
}

function createActivityModal(){
  const name=document.getElementById('modalActivityName').value.trim();
  if(!name){ alert('Posa un nom'); return; }
  const ref=db.collection('activitats').doc();
  ref.set({nom:name,data:new Date().toISOString().split('T')[0]})
    .then(()=> db.collection('classes').doc(currentClassId).update({activitats:firebase.firestore.FieldValue.arrayUnion(ref.id)}))
    .then(()=> { closeModal('modalAddActivity'); document.getElementById('modalActivityName').value=''; loadClassData(); })
    .catch(e=> alert('Error: '+e.message));
}

/* ---------------- LOAD CLASS DATA & NOTES ---------------- */
const notesThead=document.getElementById('notesThead');
const notesTbody=document.getElementById('notesTbody');
const notesTfoot=document.getElementById('notesTfoot');

function loadClassData(){
  if(!currentClassId) return;
  db.collection('classes').doc(currentClassId).get().then(doc=>{
    if(!doc.exists){ alert('Classe no trobada'); return; }
    const data=doc.data();
    classStudents=data.alumnes||[];
    classActivities=data.activitats||[];
    document.getElementById('classTitle').textContent=data.nom||'Sense nom';
    renderNotesGrid();
  });
}

function renderNotesGrid(){
  notesThead.innerHTML=''; notesTbody.innerHTML=''; notesTfoot.innerHTML='';
  // Capçalera
  let tr=document.createElement('tr');
  tr.innerHTML='<th class="border px-2 py-1 bg-gray-200">Alumne</th>';
  classActivities.forEach(aId=> tr.innerHTML+=`<th class="border px-2 py-1 bg-gray-200">${aId}</th>`);
  notesThead.appendChild(tr);
  // Cos
  Promise.all(classStudents.map(sId=> db.collection('alumnes').doc(sId).get())).then(studentsDocs=>{
    studentsDocs.forEach(s=>{
      if(!s.exists) return;
      let tr=document.createElement('tr');
      tr.innerHTML=`<td class="border px-2 py-1">${s.data().nom}</td>`;
      classActivities.forEach(aId=> {
        const val=s.data().notes[aId]||'';
        tr.innerHTML+=`<td class="border px-2 py-1 text-center">${val}</td>`;
      });
      notesTbody.appendChild(tr);
    });
  });
}

/* ---------------- EXPORT EXCEL ---------------- */
function exportExcel(){
  let wb=XLSX.utils.book_new();
  let ws_data=[['Alumne',...classActivities]];
  Promise.all(classStudents.map(sId=> db.collection('alumnes').doc(sId).get())).then(studentsDocs=>{
    studentsDocs.forEach(s=>{
      if(!s.exists) return;
      let row=[s.data().nom];
      classActivities.forEach(aId=> row.push(s.data().notes[aId]||''));
      ws_data.push(row);
    });
    let ws=XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb,ws,'Notes');
    XLSX.writeFile(wb,'NotesClasse.xlsx');
  });
}
</script>
</body>
</html>

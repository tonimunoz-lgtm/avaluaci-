<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestor de Classes</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

</head>
<body class="bg-gray-100 p-4">

<div class="max-w-6xl mx-auto">

<!-- ---------- LOGIN SCREEN ---------- -->
<div id="loginScreen" class="bg-white shadow p-6 rounded max-w-md mx-auto mt-10">
    <h2 class="text-2xl font-bold text-center mb-4">Login Professor</h2>

    <input id="email" type="email" placeholder="Email"
           class="border p-2 rounded w-full mb-2">

    <input id="password" type="password" placeholder="Contrasenya"
           class="border p-2 rounded w-full mb-4">

    <div class="flex justify-center space-x-2">
        <button onclick="login()" class="bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded">Login</button>
        <button onclick="registrar()" class="bg-green-500 hover:bg-green-700 text-white px-4 py-2 rounded">Registrar</button>
    </div>
</div>



<!-- ---------- CLASSES SCREEN (STYLE CLASSROOM) ---------- -->
<div id="classesScreen" class="hidden">

    <div class="flex justify-between items-center mb-4">
        <h2 class="text-3xl font-bold">Les meves classes</h2>
        <button onclick="crearClasse()" class="bg-blue-600 hover:bg-blue-800 text-white px-4 py-2 rounded">
            ➕ Nova classe
        </button>
    </div>

    <div id="llistaClasses" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>

</div>



<!-- ---------- SINGLE CLASS VIEW ---------- -->
<div id="classView" class="hidden">

    <button onclick="tornarInici()" class="mb-4 bg-gray-300 hover:bg-gray-400 px-3 py-1 rounded">
        ← Tornar
    </button>

    <h2 id="nomClasse" class="text-3xl font-bold mb-4"></h2>

    <div class="flex flex-col md:flex-row gap-4">

        <!-- PANEL ESQUERRA: ALUMNES -->
        <div class="bg-white shadow rounded p-4 w-full md:w-1/3">
            <h3 class="text-xl font-semibold mb-2">Alumnes</h3>
            <button onclick="afegirAlumne()"
                    class="bg-purple-600 hover:bg-purple-800 text-white px-3 py-1 rounded mb-3">
                ➕ Afegir alumne
            </button>

            <ul id="llistaAlumnes" class="list-disc pl-5"></ul>
        </div>

        <!-- PANEL DRETA: GRAELLA NOTES -->
        <div class="bg-white shadow rounded p-4 w-full md:w-2/3">

            <div class="flex justify-between items-center mb-3">
                <h3 class="text-xl font-semibold">Activitats i Notes</h3>

                <button onclick="afegirActivitat()"
                        class="bg-teal-600 hover:bg-teal-800 text-white px-3 py-1 rounded">
                    ➕ Afegir activitat
                </button>
            </div>

            <!-- TAULA -->
            <div class="overflow-x-auto">
                <table id="taulaNotes" class="min-w-full border border-gray-300">
                    <thead id="capcalera" class="bg-gray-200"></thead>
                    <tbody id="cosTaula"></tbody>
                </table>
            </div>

        </div>
    </div>

</div>


</div>

<script>
// -------------------- FIREBASE CONFIG --------------------
const firebaseConfig = {
 apiKey: "AIzaSyA0P7TWcEw9y9_13yqRhvsgWN5d3YKH7yo",
 authDomain: "gestornotes-cc6d0.firebaseapp.com",
 projectId: "gestornotes-cc6d0",
 storageBucket: "gestornotes-cc6d0.firebasestorage.app",
 messagingSenderId: "324570393360",
 appId: "1:324570393360:web:13a65fcf948813805c5395"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

let professorUID = null;
let classeActual = null;
let alumnes = [];
let activitats = [];


// -------------------- AUTH --------------------
function login(){
    auth.signInWithEmailAndPassword(
        document.getElementById("email").value,
        document.getElementById("password").value
    ).then(cred=>{
        professorUID = cred.user.uid;
        mostrarPantallaClasses();
    }).catch(err=>alert(err.message));
}

function registrar(){
    auth.createUserWithEmailAndPassword(
        document.getElementById("email").value,
        document.getElementById("password").value
    ).then(cred=>{
        professorUID = cred.user.uid;
        db.collection("professors").doc(professorUID).set({classes:[]});
        mostrarPantallaClasses();
    });
}



// -------------------- NAVEGACIÓ --------------------
function mostrarPantallaClasses(){
    document.getElementById("loginScreen").classList.add("hidden");
    document.getElementById("classesScreen").classList.remove("hidden");
    carregarClasses();
}

function obrirClasse(idClasse){
    classeActual = idClasse;
    document.getElementById("classesScreen").classList.add("hidden");
    document.getElementById("classView").classList.remove("hidden");
    carregarDadesClasse();
}

function tornarInici(){
    document.getElementById("classView").classList.add("hidden");
    document.getElementById("classesScreen").classList.remove("hidden");
}



// -------------------- CLASSES --------------------
function crearClasse(){
    const nom = prompt("Nom de la classe:");
    if(!nom) return;

    const ref = db.collection("classes").doc();
    ref.set({nom: nom, alumnes: [], activitats: []}).then(()=>{
        return db.collection("professors").doc(professorUID)
            .update({ classes: firebase.firestore.FieldValue.arrayUnion(ref.id) });
    }).then(()=>carregarClasses());
}

function carregarClasses(){
    db.collection("professors").doc(professorUID).get().then(doc=>{
        const classIDs = doc.data().classes || [];
        const contenidor = document.getElementById("llistaClasses");
        contenidor.innerHTML = "";

        classIDs.forEach(id=>{
            db.collection("classes").doc(id).get().then(cDoc=>{
                const nom = cDoc.data().nom;

                contenidor.innerHTML += `
                    <div onclick="obrirClasse('${id}')"
                         class="cursor-pointer bg-white shadow hover:shadow-lg p-5 rounded border-t-4 border-blue-500">
                        <h3 class="text-xl font-bold mb-2">${nom}</h3>
                        <p class="text-gray-500">Fes clic per obrir</p>
                    </div>
                `;
            });
        });
    });
}



// -------------------- VISTA INDIVIDUAL DE CLASSE --------------------
function carregarDadesClasse(){

    db.collection("classes").doc(classeActual).get().then(doc=>{
        alumnes = doc.data().alumnes || [];
        activitats = doc.data().activitats || [];

        document.getElementById("nomClasse").textContent = doc.data().nom;

        carregarLlistaAlumnes();
        actualitzarTaulaNotes();
    });
}



// -------------------- ALUMNES --------------------
function afegirAlumne(){
    const nom = prompt("Nom alumne:");
    if(!nom) return;

    const ref = db.collection("alumnes").doc();
    ref.set({ nom: nom, notes: {} }).then(()=>{

        return db.collection("classes").doc(classeActual)
            .update({ alumnes: firebase.firestore.FieldValue.arrayUnion(ref.id) });

    }).then(()=>carregarDadesClasse());
}

function carregarLlistaAlumnes(){
    const ul = document.getElementById("llistaAlumnes");
    ul.innerHTML = "";

    alumnes.forEach(id=>{
        db.collection("alumnes").doc(id).get().then(doc=>{
            ul.innerHTML += `<li>${doc.data().nom}</li>`;
        });
    });
}



// -------------------- ACTIVITATS --------------------
function afegirActivitat(){
    const nom = prompt("Nom activitat:");
    if(!nom) return;

    const ref = db.collection("activitats").doc();
    ref.set({nom: nom}).then(()=>{

        return db.collection("classes").doc(classeActual)
            .update({ activitats: firebase.firestore.FieldValue.arrayUnion(ref.id) });

    }).then(()=>carregarDadesClasse());
}



// -------------------- TAULA NOTES --------------------
function actualitzarTaulaNotes(){

    const cap = document.getElementById("capcalera");
    const cos = document.getElementById("cosTaula");

    cap.innerHTML = "<tr><th class='border px-2 py-1'>Alumne</th></tr>";
    cos.innerHTML = "";

    const promesesAct = activitats.map(id => db.collection("activitats").doc(id).get());

    Promise.all(promesesAct).then(activsDocs=>{

        activsDocs.forEach(a=>{
            cap.querySelector("tr").innerHTML += `<th class='border px-2 py-1'>${a.data().nom}</th>`;
        });

        alumnes.forEach(idAl=>{
            db.collection("alumnes").doc(idAl).get().then(aDoc=>{

                let fila = `<tr><td class='border px-2 py-1'>${aDoc.data().nom}</td>`;

                activsDocs.forEach(act=>{
                    const nota = (aDoc.data().notes || {})[act.id] || "";
                    fila += `
                        <td class='border px-2 py-1'>
                            <input type="number" min="0" max="10"
                                   value="${nota}"
                                   class="w-16 text-center"
                                   onchange="guardarNota('${idAl}', '${act.id}', this.value)">
                        </td>`;
                });

                fila += "</tr>";
                cos.innerHTML += fila;
            });
        });

    });

}

function guardarNota(idAlumne, idAct, valor){
    db.collection("alumnes").doc(idAlumne).update({
        [`notes.${idAct}`]: Number(valor)
    });
}

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini Gestor de Notes</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
.table-input { width:3.5rem; }
</style>
</head>
<body class="bg-gray-100 text-gray-800">

<!-- LOGIN SCREEN -->
<div id="loginScreen" class="flex justify-center items-center min-h-screen">
  <div class="bg-white p-8 rounded shadow-md w-80 flex flex-col gap-4">
    <h1 class="text-2xl font-bold text-center">Mini Gestor de Notes</h1>
    <input type="email" id="email" placeholder="Email" class="border rounded p-2 w-full">
    <input type="password" id="password" placeholder="Contrasenya" class="border rounded p-2 w-full">
    <button id="btnLogin" class="bg-blue-500 hover:bg-blue-700 text-white py-2 rounded">Login</button>
    <button id="btnRegister" class="bg-green-500 hover:bg-green-700 text-white py-2 rounded">Registrar</button>
  </div>
</div>

<!-- CLASSES SCREEN -->
<div id="classesScreen" class="hidden max-w-6xl mx-auto p-4">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-xl font-semibold">Les meves classes</h2>
    <div class="flex gap-2">
      <button id="btnCreateClass" class="bg-indigo-500 hover:bg-indigo-700 text-white px-3 py-2 rounded">Crear Classe</button>
      <button id="btnRefreshClasses" class="bg-gray-200 px-3 py-2 rounded">Refrescar</button>
      <button id="btnLogout" class="bg-red-500 hover:bg-red-700 text-white px-3 py-2 rounded">Logout</button>
    </div>
  </div>
  <div id="classesGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
</div>

<!-- CLASS SCREEN -->
<div id="classScreen" class="hidden max-w-6xl mx-auto p-4">
  <div class="flex justify-between items-center mb-4">
    <button id="btnBack" class="bg-gray-300 hover:bg-gray-400 px-3 py-1 rounded">← Tornar</button>
    <h2 id="classTitle" class="text-2xl font-bold"></h2>
    <div class="flex gap-2">
      <button id="btnAddStudent" class="bg-purple-500 hover:bg-purple-700 text-white px-3 py-1 rounded">➕ Alumne</button>
      <button id="btnAddActivity" class="bg-teal-500 hover:bg-teal-700 text-white px-3 py-1 rounded">➕ Activitat</button>
      <button id="btnExport" class="bg-yellow-400 hover:bg-yellow-500 px-3 py-1 rounded">Exportar Excel</button>
    </div>
  </div>

  <!-- Notes Grid -->
  <div class="overflow-x-auto bg-white rounded shadow p-3">
    <table id="notesTable" class="min-w-full border-collapse">
      <thead id="notesThead" class="bg-gray-100"></thead>
      <tbody id="notesTbody"></tbody>
      <tfoot id="notesTfoot" class="bg-gray-50"></tfoot>
    </table>
  </div>
</div>

<script>
// ---------- Firebase Config ----------
const firebaseConfig = { /* tu config aquí */ };
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let professorUID = null;
let currentClassId = null;
let classStudents = [];
let classActivities = [];

// ---------- AUTH ----------
document.getElementById('btnLogin').onclick = () => {
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  auth.signInWithEmailAndPassword(email,password)
    .then(u=> { professorUID=u.user.uid; loadClassesScreen(); })
    .catch(e=> alert(e.message));
};
document.getElementById('btnRegister').onclick = () => {
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  auth.createUserWithEmailAndPassword(email,password)
    .then(u=>{
      professorUID = u.user.uid;
      db.collection('professors').doc(professorUID).set({ email, classes: [] }).then(loadClassesScreen);
    }).catch(e=> alert(e.message));
};
document.getElementById('btnLogout').onclick = () => auth.signOut().then(()=> location.reload());

// ---------- CLASSES ----------
function loadClassesScreen(){
  if(!professorUID) return;
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('classScreen').classList.add('hidden');
  document.getElementById('classesScreen').classList.remove('hidden');
  const grid = document.getElementById('classesGrid');
  grid.innerHTML = '<div>Carregant...</div>';
  db.collection('professors').doc(professorUID).get().then(doc=>{
    const ids = doc.data().classes||[];
    if(ids.length===0){ grid.innerHTML='<div>No tens cap classe</div>'; return; }
    Promise.all(ids.map(id=>db.collection('classes').doc(id).get())).then(docs=>{
      grid.innerHTML='';
      docs.forEach(d=>{
        if(!d.exists) return;
        const div = document.createElement('div');
        div.className='cursor-pointer p-4 bg-white rounded shadow hover:bg-gray-50';
        div.innerHTML=`<h3 class="font-bold">${d.data().nom}</h3>
                       <p class="text-sm text-gray-500">${(d.data().alumnes||[]).length} alumnes · ${(d.data().activitats||[]).length} activitats</p>`;
        div.onclick=()=> openClass(d.id);
        grid.appendChild(div);
      });
    });
  });
}

// ---------- OPEN CLASS ----------
function openClass(id){
  currentClassId = id;
  document.getElementById('classesScreen').classList.add('hidden');
  document.getElementById('classScreen').classList.remove('hidden');
  db.collection('classes').doc(id).get().then(doc=>{
    const data = doc.data();
    classStudents = data.alumnes||[];
    classActivities = data.activitats||[];
    document.getElementById('classTitle').textContent = data.nom;
    renderNotesGrid();
  });
}
document.getElementById('btnBack').onclick = ()=> loadClassesScreen();

// ---------- NOTES GRID ----------
const notesThead = document.getElementById('notesThead');
const notesTbody = document.getElementById('notesTbody');
const notesTfoot = document.getElementById('notesTfoot');

function renderNotesGrid(){
  notesThead.innerHTML=''; notesTbody.innerHTML=''; notesTfoot.innerHTML='';

  // Header with student dropdown in first row
  const head = document.createElement('tr');
  const studentTh = document.createElement('th');
  studentTh.className='border px-2 py-1';
  studentTh.innerHTML=`Alumne<br>
    <select onchange="console.log('student selected', this.value)">
      <option value="">-- Tria Alumne --</option>
      ${classStudents.map(id=>`<option value="${id}">${id}</option>`).join('')}
    </select>`;
  head.appendChild(studentTh);

  // Activity headers
  Promise.all(classActivities.map(id=>db.collection('activitats').doc(id).get())).then(acts=>{
    acts.forEach(a=>{
      const thEl = document.createElement('th');
      thEl.className='border px-2 py-1';
      thEl.textContent = a.exists?a.data().nom:'Desconegut';
      head.appendChild(thEl);
    });
    head.appendChild(th('Mitjana'));
    notesThead.appendChild(head);

    // Rows: students
    Promise.all(classStudents.map(id=>db.collection('alumnes').doc(id).get())).then(studs=>{
      studs.forEach(sdoc=>{
        const tr = document.createElement('tr');
        const tdName = document.createElement('td');
        tdName.className='border px-2 py-1 font-medium';
        tdName.textContent = sdoc.exists?sdoc.data().nom:'Desconegut';
        tr.appendChild(tdName);

        acts.forEach(a=>{
          const td = document.createElement('td'); td.className='border px-2 py-1';
          const val = (sdoc.exists && sdoc.data().notes && sdoc.data().notes[a.id]!==undefined)?sdoc.data().notes[a.id]:'';
          const inp = document.createElement('input');
          inp.type='number'; inp.min=0; inp.max=10; inp.value=val;
          inp.className='table-input text-center border rounded';
          inp.onchange=()=> saveNote(sdoc.id,a.id,inp.value);
          td.appendChild(inp);
          tr.appendChild(td);
        });

        const avgTd = document.createElement('td'); avgTd.className='border px-2 py-1 text-right font-semibold';
        avgTd.textContent = computeAverage(sdoc.data());
        tr.appendChild(avgTd);

        notesTbody.appendChild(tr);
      });
      renderActivityAverages();
    });
  });
}

function th(txt){ const e=document.createElement('th'); e.className='border px-2 py-1'; e.textContent=txt; return e; }

function saveNote(studentId, activityId, val){
  const num = val===''?null:Number(val);
  const upd = {}; if(num===null||isNaN(num)) upd[`notes.${activityId}`]=firebase.firestore.FieldValue.delete(); else upd[`notes.${activityId}`]=num;
  db.collection('alumnes').doc(studentId).update(upd).then(renderNotesGrid);
}

function computeAverage(sdata){
  if(!sdata || !sdata.notes) return '';
  const vals = classActivities.map(aid=>sdata.notes[aid]).filter(v=>v!==undefined && !isNaN(v));
  if(vals.length===0) return '';
  return (vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(2);
}

function renderActivityAverages(){
  const tr = document.createElement('tr'); tr.className='text-sm font-semibold';
  const thEmpty = document.createElement('td'); thEmpty.className='border px-2 py-1'; thEmpty.textContent='Mitjana Activitat';
  tr.appendChild(thEmpty);
  classActivities.forEach((_,i)=>{
    const vals = Array.from(notesTbody.querySelectorAll('tr')).map(r=>{
      const inp = r.querySelectorAll('input')[i]; return inp?Number(inp.value):null;
    }).filter(v=>v!==null && !isNaN(v));
    const td = document.createElement('td'); td.className='border px-2 py-1 text-center';
    td.textContent = vals.length? (vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(2) : '';
    tr.appendChild(td);
  });
  tr.appendChild(document.createElement('td')); // empty for average
  notesTfoot.innerHTML=''; notesTfoot.appendChild(tr);
}

// ---------- Export Excel ----------
document.getElementById('btnExport').onclick = ()=>{
  const table = document.getElementById('notesTable');
  XLSX.writeFile(XLSX.utils.table_to_book(table,{sheet:"Notes"}),(document.getElementById('classTitle').textContent||'classe')+'.xlsx');
}

// ---------- Auth state ----------
auth.onAuthStateChanged(user=>{
  if(user){ professorUID = user.uid; loadClassesScreen(); }
});
</script>

</body>
</html>

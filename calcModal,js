// calcModal.js

export function initCalcModal(classData, activeTermId) {
  const modal = document.getElementById('modalCalc');
  const calcSelect = document.getElementById('calculatorActivitySelect');
  const formulaButtonsContainer = document.getElementById('formulaButtons');
  const formulaField = document.getElementById('formulaField');

  // Funció per crear els botons d'activitats
  function updateCalculatorWithActivities(activities) {
    formulaButtonsContainer.innerHTML = '';
    activities.forEach(act => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.textContent = act;
      btn.className = 'bg-gray-200 rounded px-2 py-1';
      btn.addEventListener('click', () => {
        formulaField.value += act;
      });
      formulaButtonsContainer.appendChild(btn);
    });
  }

  // Omplir el desplegable amb les graelles
  function populateCalcTermDropdown() {
    calcSelect.innerHTML = '';
    const terms = classData.terms || {};
    const termIds = Object.keys(terms);

    if (!termIds.length) {
      const opt = document.createElement('option');
      opt.textContent = 'Cap graella disponible';
      opt.disabled = true;
      calcSelect.appendChild(opt);
      return;
    }

    // Afegim opció "Totes les graelles"
    const allOpt = document.createElement('option');
    allOpt.value = 'all';
    allOpt.textContent = 'Totes les graelles';
    calcSelect.appendChild(allOpt);

    // Afegim cada graella
    termIds.forEach(id => {
      const opt = document.createElement('option');
      opt.value = id;
      opt.textContent = terms[id].name || id;
      calcSelect.appendChild(opt);
    });

    // Valor per defecte
    calcSelect.value = activeTermId || termIds[0];
  }

  // Quan canvia el desplegable
  calcSelect.addEventListener('change', (e) => {
    let activities = [];
    if (e.target.value === 'all') {
      // Totes les graelles
      Object.values(classData.terms).forEach(term => {
        activities = activities.concat(term.activities || []);
      });
    } else {
      activities = classData.terms[e.target.value]?.activities || [];
    }
    updateCalculatorWithActivities(activities);
  });

  // Obrir modal
  function openModal() {
    modal.classList.remove('hidden');
    populateCalcTermDropdown();
    calcSelect.dispatchEvent(new Event('change'));
  }

  // Tancar modal
  function closeModal() {
    modal.classList.add('hidden');
  }

  // Botons de tancar
  modal.querySelectorAll('[data-modal-close]').forEach(btn => {
    btn.addEventListener('click', closeModal);
  });

  return { openModal, closeModal };
}
